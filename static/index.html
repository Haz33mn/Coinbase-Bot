<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000;
      --surface: #121212;
      --surface2: #161616;
      --accent: #00bcd4;
      --accent-soft: rgba(0,188,212,0.18);
      --green: #1de975;
      --red: #ff4d67;
      --muted: rgba(255,255,255,0.35);
      --text: #fff;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem 0 4rem;
    }
    .hidden { display: none !important; }
    .app-shell {
      width: min(1200px, 100%);
      background: rgba(18,18,18,0.2);
      border: 1px solid rgba(255,255,255,0.02);
      border-radius: 20px;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: 1.25rem 1.75rem .75rem;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 999px;
      background: #fe3434;
    }
    .dot.online { background: #4deb5d; }
    .title { font-weight: 650; }
    .refresh-btn {
      margin-left: auto;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: .85rem;
    }
    .body-row {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 1.25rem;
      padding: 0 1.75rem 1.25rem;
    }
    .coins-panel {
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.02);
      border-radius: 18px;
      overflow-y: auto;
      max-height: 360px;
    }
    .coins-panel input {
      width: 100%;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: .45rem .6rem;
      color: #fff;
      margin: .75rem .75rem 0;
      outline: none;
      font-size: .75rem;
    }
    .coin-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: .55rem .75rem;
      margin: .5rem .5rem 0;
      border-radius: 12px;
      cursor: pointer;
    }
    .coin-item.active {
      background: rgba(0,188,212,0.12);
      border: 1px solid rgba(0,188,212,0.35);
    }
    .coin-left { display: flex; flex-direction: column; gap: .2rem; }
    .coin-name { font-size: .8rem; }
    .coin-price { font-size: .65rem; color: var(--muted); }
    .signal-pill {
      font-size: .6rem;
      padding: .2rem .5rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
    }
    .signal-buy { background: rgba(29,233,117,0.15); }
    .signal-sell { background: rgba(255,77,103,0.15); }

    .chart-panel {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.02);
      border-radius: 18px;
      min-height: 360px;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      padding: .75rem .75rem .25rem;
    }
    .chart-top {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .chart-coin-name { font-weight: 600; }
    .tf-group, .type-group, .mode-group {
      margin-left: auto;
      display: flex;
      gap: .4rem;
    }
    .btn-sm {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.03);
      color: #fff;
      border-radius: 999px;
      font-size: .6rem;
      padding: .2rem .5rem;
      cursor: pointer;
    }
    .btn-sm.active {
      background: rgba(0,188,212,0.17);
      border-color: rgba(0,188,212,0.38);
    }
    .chart-canvas-wrap {
      flex: 1;
      border-radius: 14px;
      background: radial-gradient(circle, rgba(0,188,212,0.05), rgba(0,0,0,0));
      position: relative;
      overflow: hidden;
    }
    canvas { width: 100%; height: 100%; display: block; }

    .info-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 1rem;
      padding: 0 1.75rem .75rem;
    }
    .info-card {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.02);
      border-radius: 16px;
      padding: .55rem .75rem .55rem;
    }
    .info-label {
      font-size: .6rem;
      color: var(--muted);
      text-transform: uppercase;
    }
    .info-value { margin-top: .35rem; font-size: .9rem; }
    .info-value.green { color: var(--green); }
    .info-value.red { color: var(--red); }

    .trades-row { padding: 0 1.75rem .5rem; }
    .trades-box {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.02);
      border-radius: 16px;
      font-size: .7rem;
      padding: .4rem .75rem .65rem;
    }
    .trade-line { display:flex; gap:.35rem; align-items:center; margin-bottom:.25rem; }
    .pill { font-size:.55rem; padding:.1rem .4rem; border-radius:999px; }
    .pill.paper { background: rgba(0,188,212,0.15); }
    .pill.real { background: rgba(255,169,52,0.15); }
    .pill.buy { background: rgba(29,233,117,0.3); }
    .pill.sell { background: rgba(255,77,103,0.3); }
    .ts { color: var(--muted); }

    .footer-row { padding: 0 1.75rem 1.3rem; }
    .refresh-bar {
      width: 100%;
      height: 14px;
      background: #fff;
      border-radius: 999px;
    }
    .updated { font-size: .6rem; color: var(--muted); margin-top: .35rem; }

    @media (max-width: 980px) {
      .body-row { grid-template-columns: 1fr; }
      .info-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div id="conn-dot" class="dot"></div>
      <div class="title">My Coinbase Bot</div>
      <button id="reload-btn" class="refresh-btn">⟳</button>
    </header>

    <div class="body-row">
      <div class="coins-panel">
        <input id="search" placeholder="search coin..." />
        <div id="coin-list"></div>
      </div>
      <div class="chart-panel">
        <div class="chart-top">
          <div>
            <div id="chart-coin" class="chart-coin-name">BTC-USD</div>
            <div id="chart-price" style="font-size:.7rem;color:var(--muted)">$0</div>
          </div>
          <div class="tf-group">
            <button class="btn-sm tf-btn active" data-tf="1D">1D</button>
            <button class="btn-sm tf-btn" data-tf="1W">1W</button>
            <button class="btn-sm tf-btn" data-tf="1M">1M</button>
            <button class="btn-sm tf-btn" data-tf="6M">6M</button>
            <button class="btn-sm tf-btn" data-tf="1Y">1Y</button>
          </div>
          <div class="type-group">
            <button class="btn-sm type-btn active" data-type="line">Line</button>
            <button class="btn-sm type-btn" data-type="candles">Candles</button>
          </div>
          <div class="mode-group">
            <button id="paper-btn" class="btn-sm active">Paper</button>
            <button id="real-btn" class="btn-sm">Real auto: OFF</button>
          </div>
        </div>
        <div class="chart-canvas-wrap">
          <canvas id="chart-canvas"></canvas>
        </div>
      </div>
    </div>

    <div id="paper-section" class="info-row">
      <div class="info-card">
        <div class="info-label">paper balance (USD)</div>
        <div style="display:flex;gap:.4rem;align-items:center;margin-top:.25rem;">
          <input id="paper-balance-input" value="1000" style="width:80px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);border-radius:8px;padding:.25rem .35rem;color:#fff;font-size:.7rem;outline:none;">
          <button id="paper-balance-set" class="btn-sm">set</button>
        </div>
      </div>
      <div class="info-card">
        <div class="info-label">equity now</div>
        <div id="equity-now" class="info-value">$0.00</div>
      </div>
      <div class="info-card">
        <div class="info-label">money earned</div>
        <div id="money-earned" class="info-value green">+0.00</div>
      </div>
      <div class="info-card">
        <div class="info-label">% gained</div>
        <div id="percent-gained" class="info-value green">+0.00%</div>
        <button id="paper-auto-toggle" class="btn-sm" style="margin-top:.35rem;">paper auto: OFF</button>
      </div>
    </div>

    <div id="trades-row" class="trades-row">
      <div id="trades-box" class="trades-box">no trades yet</div>
    </div>

    <div class="footer-row">
      <div class="refresh-bar" id="refresh-bar"></div>
      <div id="updated" class="updated">updated --:--</div>
    </div>
  </div>

  <script>
    const API = "";
    let CURRENT = {
      state: null,
      tf: "1D",
      chartType: "line",
      selected: "BTC-USD",
    };

    const coinListEl = document.getElementById("coin-list");
    const chartCoinEl = document.getElementById("chart-coin");
    const chartPriceEl = document.getElementById("chart-price");
    const chartCanvas = document.getElementById("chart-canvas");
    const updatedEl = document.getElementById("updated");
    const paperSection = document.getElementById("paper-section");
    const tradesRow = document.getElementById("trades-row");
    const paperBalanceInput = document.getElementById("paper-balance-input");
    const equityNowEl = document.getElementById("equity-now");
    const moneyEarnedEl = document.getElementById("money-earned");
    const percentGainedEl = document.getElementById("percent-gained");
    const tradesBox = document.getElementById("trades-box");
    const paperAutoBtn = document.getElementById("paper-auto-toggle");
    const paperBtn = document.getElementById("paper-btn");
    const realBtn = document.getElementById("real-btn");
    const ctx = chartCanvas.getContext("2d");

    async function fetchState() {
      const res = await fetch(API + "/state");
      const data = await res.json();
      CURRENT.state = data;
      CURRENT.selected = data.selected || CURRENT.selected;
      renderState();
      fetchHistory(CURRENT.selected, CURRENT.tf);
    }

    async function fetchHistory(symbol, tf) {
      const res = await fetch(API + `/history/${encodeURIComponent(symbol)}?tf=${tf}`);
      const data = await res.json();
      drawChart(data.points || []);
    }

    function renderState() {
      const st = CURRENT.state;
      const dot = document.getElementById("conn-dot");
      if (st.connected) dot.classList.add("online"); else dot.classList.remove("online");

      coinListEl.innerHTML = "";
      (st.coins || []).forEach(c => {
        const item = document.createElement("div");
        item.className = "coin-item" + (c.symbol === st.selected ? " active" : "");
        item.dataset.symbol = c.symbol;
        item.innerHTML = `
          <div class="coin-left">
            <div class="coin-name">${c.symbol}</div>
            <div class="coin-price">$${Number(c.price || 0).toLocaleString()}</div>
          </div>
          <div class="signal-pill ${c.signal === "BUY" ? "signal-buy" : c.signal === "SELL" ? "signal-sell" : ""}">
            ${c.signal || "HOLD"} · ${c.conf || 50}%
          </div>
        `;
        item.addEventListener("click", () => selectCoin(c.symbol));
        coinListEl.appendChild(item);
      });

      chartCoinEl.textContent = st.selected;
      const coin = (st.coins || []).find(c => c.symbol === st.selected);
      chartPriceEl.textContent = coin ? "$" + Number(coin.price || 0).toLocaleString() : "$0";

      // paper section show/hide
      if (st.paper_enabled) {
        paperSection.classList.remove("hidden");
        tradesRow.classList.remove("hidden");
      } else {
        paperSection.classList.add("hidden");
        tradesRow.classList.add("hidden");
      }

      paperBalanceInput.value = st.paper_balance ?? 1000;
      equityNowEl.textContent = "$" + (st.paper_equity ?? 0).toFixed(2);
      const pl = st.paper_pl ?? 0;
      moneyEarnedEl.textContent = (pl >= 0 ? "+" : "-") + "$" + Math.abs(pl).toFixed(2);
      moneyEarnedEl.className = "info-value " + (pl >= 0 ? "green" : "red");
      const pct = st.paper_balance ? (pl / st.paper_balance) * 100 : 0;
      percentGainedEl.textContent = (pct >= 0 ? "+" : "-") + Math.abs(pct).toFixed(2) + "%";
      percentGainedEl.className = "info-value " + (pct >= 0 ? "green" : "red");

      paperAutoBtn.textContent = "paper auto: " + (st.paper_auto ? "ON" : "OFF");
      realBtn.textContent = "Real auto: " + (st.real_auto ? "ON" : "OFF");

      // trades  (paper + real)
      const paperTrades = st.paper_trades || [];
      const realTrades = st.real_trades || [];
      let html = "";
      if (paperTrades.length) {
        html += `<div style="font-weight:600;margin-bottom:.25rem;">PAPER TRADES (last)</div>`;
        paperTrades.forEach(t => {
          html += `<div class="trade-line">
            <span class="pill paper">PAPER</span>
            <span class="pill ${t.side === "BUY" ? "buy" : "sell"}">${t.side}</span>
            <b>${t.symbol}</b>
            <span>${Number(t.qty || 0).toFixed(4)}</span>
            <span>@ $${Number(t.price || 0).toFixed(2)}</span>
            <span class="ts">${fmtTime(t.at)}</span>
          </div>`;
        });
      }
      if (realTrades.length) {
        html += `<div style="font-weight:600;margin:.4rem 0 .25rem;">REAL TRADES (last)</div>`;
        realTrades.forEach(t => {
          html += `<div class="trade-line">
            <span class="pill real">REAL</span>
            <span class="pill ${t.side === "BUY" ? "buy" : "sell"}">${t.side}</span>
            <b>${t.symbol}</b>
            <span>${Number(t.qty || 0).toFixed(4)}</span>
            <span>@ $${Number(t.price || 0).toFixed(2)}</span>
            <span class="ts">${fmtTime(t.at)}</span>
          </div>`;
        });
      }
      tradesBox.innerHTML = html || "no trades yet";

      updatedEl.textContent = "updated " + (st.last_update ? new Date(st.last_update).toLocaleTimeString() : "--:--");
    }

    async function selectCoin(symbol) {
      CURRENT.selected = symbol;
      await fetch(API + "/select", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({symbol})
      });
      await fetchState();
    }

    function drawChart(points) {
      const w = chartCanvas.clientWidth || 500;
      const h = chartCanvas.clientHeight || 220;
      chartCanvas.width = w * 2;
      chartCanvas.height = h * 2;
      const dpr = 2;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,w,h);
      if (!points.length) return;
      const max = Math.max(...points.map(p => p.c));
      const min = Math.min(...points.map(p => p.c));
      const padX = 16, padY = 12;
      const usableW = w - padX*2;
      const usableH = h - padY*2;
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#38eaff";
      points.forEach((p,i) => {
        const x = padX + (i / Math.max(points.length-1,1)) * usableW;
        const y = padY + (1 - (p.c - min) / Math.max((max-min), 0.0001)) * usableH;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function fmtTime(t){
      if(!t) return "";
      return new Date(t).toLocaleTimeString();
    }

    // events
    document.getElementById("reload-btn").addEventListener("click", fetchState);
    document.getElementById("paper-balance-set").addEventListener("click", async () => {
      const v = Number(paperBalanceInput.value || 0);
      await fetch(API + "/paper/balance", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({balance: v})
      });
      fetchState();
    });
    paperAutoBtn.addEventListener("click", async () => {
      const on = !(CURRENT.state && CURRENT.state.paper_auto);
      await fetch(API + "/paper/toggle", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({on})
      });
      fetchState();
    });
    paperBtn.addEventListener("click", async () => {
      const enabled = !(CURRENT.state && CURRENT.state.paper_enabled);
      await fetch(API + "/paper/enable", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({enabled})
      });
      fetchState();
    });
    realBtn.addEventListener("click", async () => {
      const on = !(CURRENT.state && CURRENT.state.real_auto);
      await fetch(API + "/real/toggle", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({on})
      });
      fetchState();
    });
    document.querySelectorAll(".tf-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tf-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        CURRENT.tf = btn.dataset.tf;
        fetchHistory(CURRENT.selected, CURRENT.tf);
      });
    });

    fetchState();
  </script>
</body>
</html>
