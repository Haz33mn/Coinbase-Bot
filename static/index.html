<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000;
      --card: #101010;
      --card2: #151515;
      --muted: rgba(255, 255, 255, 0.25);
      --line: #39e6d4;
      --green: #16db65;
      --red: #ff6b6b;
      --white: #ffffff;
      --border: rgba(255, 255, 255, 0.04);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem 1.5rem 4.5rem;
    }
    .app-shell {
      width: min(1200px, 100vw);
      background: var(--card);
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.35);
    }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.1rem 1.4rem 0.4rem;
    }
    .title-block {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #16db65;
    }
    .top-buttons {
      display: flex;
      gap: 0.5rem;
    }
    .btn-light {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      font-size: 0.62rem;
      padding: 0.28rem 0.65rem;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.75);
    }
    .btn-toggle-on {
      background: #fff;
      color: #000;
    }
    .main-row {
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: 0.8rem;
      padding: 0.6rem 1.4rem 0.6rem;
      min-height: 360px;
    }
    .coins-panel {
      background: rgba(255, 255, 255, 0.025);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      padding: 0.6rem 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      height: 360px;
    }
    .search-box {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 11px;
      padding: 0.3rem 0.5rem;
      font-size: 0.65rem;
      outline: none;
      color: #fff;
    }
    .coin-list {
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }
    .coin {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.015);
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 0.28rem 0.38rem 0.28rem 0.6rem;
      cursor: pointer;
      transition: 0.12s ease;
    }
    .coin:hover { background: rgba(255, 255, 255, 0.03); }
    .coin.active {
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(57, 230, 212, 0.1);
    }
    .coin-name { font-size: 0.63rem; font-weight: 500; }
    .coin-price { font-size: 0.58rem; color: rgba(255, 255, 255, 0.4); }
    .signal-pill {
      font-size: 0.5rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 999px;
      padding: 0.05rem 0.35rem 0.1rem;
      white-space: nowrap;
    }
    .chart-panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      padding: 0.4rem 0.4rem 0.5rem;
    }
    .chart-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.35rem;
    }
    .chart-title-block { display: flex; flex-direction: column; gap: 0.1rem; }
    .chart-title { font-size: 0.7rem; font-weight: 600; }
    .chart-price { font-size: 0.6rem; color: rgba(255, 255, 255, 0.45); }
    .chart-controls { display: flex; gap: 0.3rem; }
    .tf-btn,
    .style-btn {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 999px;
      padding: 0.23rem 0.45rem;
      font-size: 0.55rem;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.55);
    }
    .tf-btn.active,
    .style-btn.active {
      background: rgba(255, 255, 255, 0.11);
      color: #fff;
    }
    .chart-canvas-wrap {
      flex: 1;
      border-radius: 12px;
      overflow: hidden;
      background: #0f0f0f;
    }
    #chartCanvas {
      width: 100%;
      height: 255px;
      display: block;
    }
    /* performance Row */
    .perf-bar {
      display: flex;
      gap: 0.7rem;
      padding: 0.35rem 1.4rem 0.6rem;
      align-items: center;
    }
    .perf-item {
      background: rgba(255, 255, 255, 0.015);
      border: 1px solid rgba(255, 255, 255, 0.015);
      border-radius: 12px;
      padding: 0.4rem 0.75rem 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 140px;
    }
    .perf-label { font-size: 0.52rem; color: rgba(255, 255, 255, 0.45); }
    .perf-value { font-size: 0.68rem; font-weight: 600; }
    .pnl-green { color: #00f490; }
    .pnl-red { color: #ff6b6b; }
    .paper-input-row { display: flex; gap: 0.35rem; align-items: center; }
    .paper-input-row input {
      width: 80px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      padding: 0.23rem 0.35rem;
      font-size: 0.6rem;
      color: #fff;
      outline: none;
    }
    .paper-input-row button {
      background: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.25rem 0.45rem;
      font-size: 0.55rem;
      cursor: pointer;
      color: #000;
      font-weight: 500;
    }
    .refresh-bar {
      margin-top: 0.3rem;
      background: #fff;
      border-radius: 1000px;
      height: 14px;
      margin-inline: 1.4rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.55rem;
      color: #000;
      font-weight: 600;
      padding-bottom: 0.35rem;
    }
    .footer-line {
      font-size: 0.55rem;
      color: rgba(255, 255, 255, 0.26);
      padding: 0.45rem 1.4rem 1rem;
      display: flex;
      justify-content: space-between;
    }
    @media (max-width: 920px) {
      .main-row { grid-template-columns: 1fr; }
      .perf-bar { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-header">
      <div class="title-block">
        <span id="connDot" class="status-dot"></span>
        <span>My Coinbase Bot</span>
      </div>
      <div class="top-buttons">
        <button id="paperOnceBtn" class="btn-light">Paper trade</button>
        <button id="realAutoBtn" class="btn-light">Real auto: OFF</button>
      </div>
    </div>

    <div class="main-row">
      <div class="coins-panel">
        <input id="searchInput" class="search-box" placeholder="search coin..." />
        <div id="coinContainer" class="coin-list"></div>
      </div>
      <div class="chart-panel">
        <div class="chart-top">
          <div class="chart-title-block">
            <div id="chartTitle" class="chart-title">BTC-USD</div>
            <div id="chartPrice" class="chart-price">$0</div>
          </div>
          <div class="chart-controls">
            <button class="tf-btn active" data-tf="1D">1D</button>
            <button class="tf-btn" data-tf="1W">1W</button>
            <button class="tf-btn" data-tf="1M">1M</button>
            <button class="tf-btn" data-tf="6M">6M</button>
            <button class="tf-btn" data-tf="1Y">1Y</button>
          </div>
          <div class="chart-controls">
            <button class="style-btn active" data-style="line">Line</button>
            <button class="style-btn" data-style="candles">Candles</button>
          </div>
        </div>
        <div class="chart-canvas-wrap">
          <canvas id="chartCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- simple performance row -->
    <div class="perf-bar">
      <div class="perf-item">
        <span class="perf-label">paper balance (USD)</span>
        <div class="paper-input-row">
          <input id="paperBalanceInput" type="number" min="100" value="1000" />
          <button id="paperBalanceSetBtn">set</button>
        </div>
      </div>
      <div class="perf-item">
        <span class="perf-label">equity now</span>
        <span id="paperEquityEl" class="perf-value">$1,000.00</span>
      </div>
      <div class="perf-item">
        <span class="perf-label">money earned</span>
        <span id="paperPnlEl" class="perf-value pnl-green">+$0.00</span>
      </div>
      <div class="perf-item">
        <span class="perf-label">% gained</span>
        <span id="paperPctEl" class="perf-value pnl-green">+0.00%</span>
      </div>
    </div>

    <div id="refreshBtn" class="refresh-bar">Refresh</div>
    <div class="footer-line">
      <span id="updatedAt">updated …</span>
      <span style="font-size:0.48rem;">live from Coinbase</span>
    </div>
  </div>

  <script>
    const coinContainer = document.getElementById("coinContainer");
    const chartCanvas = document.getElementById("chartCanvas");
    const ctx = chartCanvas.getContext("2d");
    const connDot = document.getElementById("connDot");
    const tfButtons = document.querySelectorAll(".tf-btn");
    const styleButtons = document.querySelectorAll(".style-btn");
    const chartTitle = document.getElementById("chartTitle");
    const chartPrice = document.getElementById("chartPrice");
    const updatedAt = document.getElementById("updatedAt");

    const paperBalanceInput = document.getElementById("paperBalanceInput");
    const paperBalanceSetBtn = document.getElementById("paperBalanceSetBtn");
    const paperEquityEl = document.getElementById("paperEquityEl");
    const paperPnlEl = document.getElementById("paperPnlEl");
    const paperPctEl = document.getElementById("paperPctEl");
    const paperOnceBtn = document.getElementById("paperOnceBtn");
    const realAutoBtn = document.getElementById("realAutoBtn");

    let prices = {};
    let filteredCoins = [];
    let selectedSymbol = "BTC-USD";
    let currentTF = "1D";
    let currentStyle = "line";
    let chartData = [];
    let chartIsFallback = false;
    let realAutoOn = false;

    function resizeCanvas() {
      const rect = chartCanvas.getBoundingClientRect();
      chartCanvas.width = rect.width * window.devicePixelRatio;
      chartCanvas.height = rect.height * window.devicePixelRatio;
      ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
      drawChart();
    }
    window.addEventListener("resize", resizeCanvas);

    function renderCoinList() {
      coinContainer.innerHTML = "";
      filteredCoins.forEach((sym) => {
        const price = prices[sym] ?? 0;
        const div = document.createElement("div");
        div.className = "coin" + (sym === selectedSymbol ? " active" : "");
        div.innerHTML = `
          <div>
            <div class="coin-name">${sym}</div>
            <div class="coin-price">$${price.toLocaleString()}</div>
          </div>
          <span class="signal-pill">HOLD • 50%</span>
        `;
        div.addEventListener("click", () => {
          selectedSymbol = sym;
          renderCoinList();
          loadHistory();
        });
        coinContainer.appendChild(div);
      });
    }

    async function loadPrices() {
      try {
        const r = await fetch("/prices");
        const data = await r.json();
        prices = data.prices || {};
        filteredCoins = Object.keys(prices);
        if (!filteredCoins.includes(selectedSymbol) && filteredCoins.length) {
          selectedSymbol = filteredCoins[0];
        }
        renderCoinList();
        chartTitle.textContent = selectedSymbol;
        chartPrice.textContent = "$" + (prices[selectedSymbol] || 0).toLocaleString();
        updatedAt.textContent = "updated " + (data.updated || "");
        connDot.style.background = "#16db65";
      } catch (err) {
        connDot.style.background = "#ff6b6b";
      }
    }

    async function loadHistory() {
      try {
        const r = await fetch(`/history/${selectedSymbol}?tf=${currentTF}`);
        const data = await r.json();
        chartData = data.candles || [];
        chartIsFallback = !!data.fallback;
        drawChart();
      } catch (err) {
        chartData = [];
        chartIsFallback = true;
        drawChart();
      }
    }

    async function loadPaperStats() {
      try {
        const r = await fetch("/paper-stats");
        const data = await r.json();
        paperBalanceInput.value = data.initial;
        paperEquityEl.textContent = "$" + data.equity.toLocaleString();
        const pnl = data.pnl || 0;
        paperPnlEl.textContent = (pnl >= 0 ? "+" : "") + "$" + pnl.toFixed(2);
        paperPnlEl.className = "perf-value " + (pnl >= 0 ? "pnl-green" : "pnl-red");
        const pct = data.percent || 0;
        paperPctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
        paperPctEl.className = "perf-value " + (pct >= 0 ? "pnl-green" : "pnl-red");
      } catch (err) {}
    }

    function drawChart() {
      const w = chartCanvas.width / window.devicePixelRatio;
      const h = chartCanvas.height / window.devicePixelRatio;
      ctx.clearRect(0, 0, w, h);

      if (!chartData || chartData.length === 0) {
        ctx.fillStyle = "rgba(255,255,255,0.14)";
        ctx.font = "12px system-ui";
        ctx.fillText("no data…", 12, 20);
        return;
      }

      const values = chartData.map((c) => c.c);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const pad = 20;
      const usableW = w - pad * 2;
      const usableH = h - pad * 2;

      if (currentStyle === "line") {
        ctx.strokeStyle = "#39e6d4";
        ctx.lineWidth = 1.6;
        ctx.beginPath();
        chartData.forEach((c, i) => {
          const x = pad + (i / Math.max(1, chartData.length - 1)) * usableW;
          const y = pad + (1 - (c.c - min) / (max - min || 1)) * usableH;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      } else {
        const barW = Math.max(2, usableW / chartData.length - 1);
        chartData.forEach((c, i) => {
          const x = pad + (i / Math.max(1, chartData.length - 1)) * usableW;
          const openY = pad + (1 - (c.o - min) / (max - min || 1)) * usableH;
          const closeY = pad + (1 - (c.c - min) / (max - min || 1)) * usableH;
          const highY = pad + (1 - (c.h - min) / (max - min || 1)) * usableH;
          const lowY = pad + (1 - (c.l - min) / (max - min || 1)) * usableH;
          const up = c.c >= c.o;
          ctx.strokeStyle = up ? "#06d6a0" : "#ff6060";
          ctx.beginPath();
          ctx.moveTo(x, highY);
          ctx.lineTo(x, lowY);
          ctx.stroke();
          ctx.fillStyle = up ? "#06d6a0" : "#ff6060";
          const rectY = Math.min(openY, closeY);
          const rectH = Math.abs(closeY - openY);
          ctx.fillRect(x - barW / 2, rectY, barW, rectH || 2);
        });
      }

      if (chartIsFallback) {
        ctx.fillStyle = "rgba(255,76,76,0.25)";
        ctx.fillRect(w - 100, 10, 90, 16);
        ctx.fillStyle = "#fff";
        ctx.font = "10px system-ui";
        ctx.fillText("fallback data", w - 94, 21);
      }
    }

    // timeframes
    tfButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        tfButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentTF = btn.dataset.tf;
        loadHistory();
      });
    });

    // styles
    styleButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        styleButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentStyle = btn.dataset.style;
        drawChart();
      });
    });

    // search
    document.getElementById("searchInput").addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase();
      filteredCoins = Object.keys(prices).filter((s) => s.toLowerCase().includes(q));
      if (!filteredCoins.includes(selectedSymbol) && filteredCoins.length) {
        selectedSymbol = filteredCoins[0];
      }
      renderCoinList();
    });

    // refresh
    document.getElementById("refreshBtn").addEventListener("click", async () => {
      await loadPrices();
      await loadHistory();
      await loadPaperStats();
    });

    // set paper balance
    paperBalanceSetBtn.addEventListener("click", async () => {
      const val = parseFloat(paperBalanceInput.value);
      if (isNaN(val)) return;
      await fetch("/paper-config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initial_balance: val }),
      });
      await loadPaperStats();
    });

    // paper trade once
    paperOnceBtn.addEventListener("click", async () => {
      const r = await fetch("/paper-trade-once", { method: "POST" });
      const data = await r.json();
      await loadPaperStats();
    });

    // real auto toggle
    realAutoBtn.addEventListener("click", async () => {
      const next = !realAutoOn;
      const r = await fetch("/real-auto", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ on: next }),
      });
      const data = await r.json();
      realAutoOn = data.on;
      realAutoBtn.textContent = realAutoOn ? "Real auto: ON" : "Real auto: OFF";
      if (realAutoOn) {
        realAutoBtn.classList.add("btn-toggle-on");
      } else {
        realAutoBtn.classList.remove("btn-toggle-on");
      }
    });

    async function checkRealAuto() {
      const r = await fetch("/real-auto");
      const data = await r.json();
      realAutoOn = data.on;
      realAutoBtn.textContent = realAutoOn ? "Real auto: ON" : "Real auto: OFF";
      if (realAutoOn) {
        realAutoBtn.classList.add("btn-toggle-on");
      } else {
        realAutoBtn.classList.remove("btn-toggle-on");
      }
    }

    (async () => {
      await loadPrices();
      await loadHistory();
      await loadPaperStats();
      await checkRealAuto();
      resizeCanvas();
    })();

    setInterval(loadPrices, 20000);
    setInterval(loadPaperStats, 25000);
  </script>
</body>
</html>
