<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#000;
      --panel:#101010;
      --panel2:#151515;
      --muted:rgba(255,255,255,.35);
      --accent:#00bcd4;
      --green:#1de975;
      --red:#ff4d67;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:1.5rem 0 4rem;
    }
    .app{
      width:min(1200px,100%);
      border:1px solid rgba(255,255,255,.02);
      border-radius:20px;
      background:rgba(0,0,0,.1);
    }
    header{
      display:flex;
      gap:.6rem;
      align-items:center;
      padding:1rem 1.5rem .8rem;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#ff4d4d;}
    .dot.online{background:#35ea53;}
    .title{font-weight:650;}
    .btn-head{
      margin-left:auto;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.04);
      border-radius:999px;
      color:#fff;
      font-size:.65rem;
      padding:.25rem .6rem;
      cursor:pointer;
    }
    .body{
      padding:0 1.5rem 1rem;
      display:grid;
      grid-template-columns:240px 1fr;
      gap:1rem;
    }
    .coins{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.02);
      border-radius:16px;
      max-height:360px;
      overflow-y:auto;
    }
    .coins input{
      width:calc(100% - 1rem);
      margin:.5rem .5rem 0;
      background:rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.03);
      border-radius:10px;
      padding:.35rem .5rem;
      color:#fff;
      font-size:.7rem;
      outline:none;
    }
    .coin{
      margin:.5rem .45rem 0;
      padding:.45rem .5rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-radius:12px;
      cursor:pointer;
      transition:background .1s;
    }
    .coin:hover{
      background:rgba(255,255,255,.02);
    }
    .coin.active{
      background:rgba(0,188,212,.12);
      border:1px solid rgba(0,188,212,.35);
    }
    .coin-name{font-size:.78rem;}
    .coin-price{font-size:.6rem;color:var(--muted);}
    .signal{
      font-size:.58rem;
      padding:.14rem .45rem;
      border-radius:999px;
      background:rgba(255,255,255,.04);
    }
    .chart-wrap{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.02);
      border-radius:16px;
      padding:.7rem .7rem .4rem;
      display:flex;
      flex-direction:column;
      gap:.6rem;
      min-height:360px;
    }
    .chart-top{
      display:flex;
      align-items:center;
      gap:.6rem;
    }
    .tf, .type{
      margin-left:auto;
      display:flex;
      gap:.4rem;
    }
    .btn-sm{
      background:rgba(255,255,255,.02);
      border:1px solid transparent;
      border-radius:999px;
      font-size:.6rem;
      padding:.22rem .55rem;
      cursor:pointer;
      color:#fff;
    }
    .btn-sm.active{
      background:rgba(0,188,212,.16);
      border-color:rgba(0,188,212,.35);
    }
    .chart-box{
      flex:1;
      background:radial-gradient(circle,rgba(0,188,212,.05),rgba(0,0,0,0));
      border-radius:14px;
      min-height:230px;
      overflow:hidden;
    }
    canvas{width:100%;height:100%;display:block;}
    .trades{
      padding:0 1.5rem 1rem;
    }
    .trades-box{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.02);
      border-radius:14px;
      padding:.5rem .7rem;
      font-size:.7rem;
    }
    .trade-line{display:flex;gap:.4rem;align-items:center;margin-bottom:.25rem;flex-wrap:wrap;}
    .pill{font-size:.55rem;padding:.1rem .4rem;border-radius:999px;}
    .pill.real{background:rgba(255,172,44,.15);}
    .pill.buy{background:rgba(29,233,117,.35);}
    .pill.sell{background:rgba(255,77,103,.35);}
    .footer{padding:0 1.5rem 1rem;}
    .bar{height:14px;background:#fff;border-radius:999px;cursor:pointer;}
    .updated{font-size:.6rem;color:var(--muted);margin-top:.3rem;}
    @media(max-width:980px){
      .body{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div id="conn-dot" class="dot"></div>
      <div class="title">My Coinbase Bot</div>
      <button id="refresh" class="btn-head">refresh</button>
      <button id="real-toggle" class="btn-head">Real auto: OFF</button>
    </header>

    <div class="body">
      <div class="coins">
        <input id="search" placeholder="search coin..." />
        <div id="coin-list"></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-top">
          <div>
            <div id="coin-label" style="font-weight:600;">BTC-USD</div>
            <div id="coin-price" style="font-size:.69rem;color:var(--muted);">$0</div>
          </div>
          <div class="tf">
            <button class="btn-sm tf-btn active" data-tf="1D">1D</button>
            <button class="btn-sm tf-btn" data-tf="1W">1W</button>
            <button class="btn-sm tf-btn" data-tf="1M">1M</button>
            <button class="btn-sm tf-btn" data-tf="6M">6M</button>
            <button class="btn-sm tf-btn" data-tf="1Y">1Y</button>
          </div>
          <div class="type">
            <button class="btn-sm type-btn active" data-type="line">Line</button>
            <button class="btn-sm type-btn" data-type="candles">Candles</button>
          </div>
        </div>
        <div class="chart-box">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>

    <div class="trades">
      <div class="trades-box" id="trades-box">
        no real trades yet
      </div>
    </div>

    <div class="footer">
      <div class="bar" id="reload-bar" title="reload"></div>
      <div id="updated" class="updated">updated --:--</div>
    </div>
  </div>

  <script>
    const API = "";
    const chart = document.getElementById("chart");
    const ctx = chart.getContext("2d");
    let CURRENT = {
      tf: "1D",
      type: "line",
      selected: "BTC-USD",
      state: null,
      allCoins: [],
      search: ""
    };

    async function loadState(){
      const r = await fetch(API + "/state");
      const st = await r.json();
      CURRENT.state = st;
      CURRENT.selected = st.selected;
      CURRENT.allCoins = st.coins || [];
      renderState();
      // after state loads, always refresh chart for selected coin
      await loadHistory(CURRENT.selected, CURRENT.tf);
    }

    async function loadHistory(symbol, tf){
      const r = await fetch(API + `/history/${encodeURIComponent(symbol)}?tf=${tf}`);
      const data = await r.json();
      drawChart(data.points || []);
    }

    function renderState(){
      const st = CURRENT.state;
      document.getElementById("conn-dot").classList.toggle("online", !!st.connected);

      // filter coins by search
      const filter = (CURRENT.search || "").toUpperCase();
      const coinsFiltered = (st.coins || []).filter(c =>
        c.symbol.toUpperCase().includes(filter)
      );

      const list = document.getElementById("coin-list");
      list.innerHTML = "";
      coinsFiltered.forEach(c=>{
        const el = document.createElement("div");
        el.className = "coin" + (c.symbol === st.selected ? " active" : "");
        el.innerHTML = `
          <div>
            <div class="coin-name">${c.symbol}</div>
            <div class="coin-price">$${Number(c.price||0).toLocaleString()}</div>
          </div>
          <div class="signal">${c.signal || "HOLD"} Â· ${c.conf || 50}%</div>
        `;
        el.addEventListener("click", ()=>selectCoin(c.symbol));
        list.appendChild(el);
      });

      document.getElementById("coin-label").textContent = st.selected;
      const coin = (st.coins || []).find(c=>c.symbol===st.selected);
      document.getElementById("coin-price").textContent = coin ? "$" + Number(coin.price||0).toLocaleString() : "$0";

      document.getElementById("real-toggle").textContent = "Real auto: " + (st.real_auto ? "ON" : "OFF");

      // trades
      const tb = document.getElementById("trades-box");
      if ((st.real_trades || []).length === 0){
        tb.textContent = "no real trades yet";
      } else {
        tb.innerHTML = `<div style="margin-bottom:.35rem;font-weight:600;">recent real trades</div>`;
        (st.real_trades || []).forEach(t=>{
          tb.innerHTML += `
            <div class="trade-line">
              <span class="pill real">REAL</span>
              <span class="pill ${t.side==="BUY"?"buy":"sell"}">${t.side}</span>
              <b>${t.symbol}</b>
              <span>${Number(t.qty||0).toFixed(6)}</span>
              <span>@ $${Number(t.price||0).toFixed(2)}</span>
              <span style="color:var(--muted)">${new Date(t.at).toLocaleTimeString()}</span>
            </div>
          `;
        });
      }

      document.getElementById("updated").textContent = "updated " + (st.last_update ? new Date(st.last_update).toLocaleTimeString() : "--:--");
    }

    function drawChart(points){
      const w = chart.clientWidth || 500;
      const h = chart.clientHeight || 230;
      const dpr = window.devicePixelRatio || 1;
      chart.width = w * dpr;
      chart.height = h * dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,w,h);
      if (!points.length) return;

      let max = Math.max(...points.map(p=>p.c));
      let min = Math.min(...points.map(p=>p.c));
      const pad = (max - min) * 0.08;
      max += pad; min -= pad;

      const padX = 16, padY = 10;
      const usableW = w - padX*2;
      const usableH = h - padY*2;

      ctx.lineWidth = 2;
      ctx.strokeStyle = "#38eaff";
      ctx.beginPath();
      points.forEach((p,i)=>{
        const x = padX + (i / Math.max(points.length-1,1)) * usableW;
        const y = padY + (1 - (p.c - min)/(max-min)) * usableH;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    async function selectCoin(symbol){
      CURRENT.selected = symbol;
      await fetch(API + "/select", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({symbol})
      });
      // after selecting, reload state + chart
      await loadState();
    }

    document.getElementById("refresh").addEventListener("click", loadState);
    document.getElementById("reload-bar").addEventListener("click", loadState);

    document.getElementById("real-toggle").addEventListener("click", async ()=>{
      const st = CURRENT.state || {};
      const on = !st.real_auto;
      await fetch(API + "/real/toggle", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({on})
      });
      loadState();
    });

    document.querySelectorAll(".tf-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tf-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        CURRENT.tf = btn.dataset.tf;
        loadHistory(CURRENT.selected, CURRENT.tf);
      });
    });

    document.getElementById("search").addEventListener("input", (e)=>{
      CURRENT.search = e.target.value || "";
      renderState(); // re-render list only
    });

    // initial
    loadState();
  </script>
</body>
</html>
