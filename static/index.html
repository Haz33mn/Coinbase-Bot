<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000;
      --card: #101010;
      --card2: #151515;
      --muted: rgba(255, 255, 255, 0.3);
      --line: #45d2c8;
      --green: #11d881;
      --red: #ff6b6b;
      --outline: rgba(255, 255, 255, 0.04);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem 1rem 4rem;
    }
    .app-shell {
      width: min(1200px, 100%);
      background: var(--card);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 0 45px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }
    .topbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1.25rem 1.25rem 0.5rem;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      background: #f43f5e;
    }
    .status-dot.online {
      background: #22c55e;
    }
    .title {
      font-weight: 600;
      font-size: 1.05rem;
    }
    .main-row {
      display: flex;
      gap: 1.25rem;
      padding: 0 1.25rem 0.75rem;
      margin-top: 0.75rem;
    }
    .coin-list {
      width: 210px;
      background: rgba(255, 255, 255, 0.01);
      border: 1px solid rgba(255, 255, 255, 0.02);
      border-radius: 14px;
      padding: 0.75rem 0.5rem 0.75rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .coin-search {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 9999px;
      padding: 0.3rem 0.7rem;
      font-size: 0.7rem;
      color: #fff;
      outline: none;
    }
    .coin-scroll {
      overflow-y: auto;
      max-height: 370px;
      padding-right: 0.4rem;
    }
    .coin-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.25rem;
      padding: 0.4rem 0.4rem 0.4rem 0.6rem;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.12s ease-out;
    }
    .coin-item.active {
      background: rgba(69, 210, 200, 0.16);
      border: 1px solid rgba(69, 210, 200, 0.32);
    }
    .coin-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .coin-symbol {
      font-size: 0.68rem;
    }
    .coin-price {
      font-size: 0.62rem;
      color: rgba(255, 255, 255, 0.45);
    }
    .coin-signal {
      font-size: 0.55rem;
      padding: 2px 6px 2px 6px;
      border-radius: 9999px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.03);
      text-transform: uppercase;
    }
    .coin-signal.buy {
      background: rgba(17, 216, 129, 0.18);
      border-color: rgba(17, 216, 129, 0.35);
    }
    .coin-signal.sell {
      background: rgba(255, 107, 107, 0.14);
      border-color: rgba(255, 107, 107, 0.3);
    }
    .chart-card {
      flex: 1;
      background: rgba(255, 255, 255, 0.01);
      border: 1px solid rgba(255, 255, 255, 0.02);
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      min-height: 340px;
      overflow: hidden;
    }
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 1rem 0.35rem;
      gap: 1rem;
    }
    .chart-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .chart-symbol {
      font-weight: 600;
      font-size: 0.75rem;
    }
    .chart-price {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.4);
    }
    .chart-tabs,
    .view-tabs {
      display: flex;
      gap: 0.35rem;
    }
    .chip {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 9999px;
      padding: 3px 11px;
      font-size: 0.6rem;
      cursor: pointer;
      transition: 0.12s;
    }
    .chip.active {
      background: rgba(69, 210, 200, 0.15);
      border: 1px solid rgba(69, 210, 200, 0.35);
    }
    /* THIS FIXES THE OVERFLOW */
    .chart-body {
      position: relative;
      height: 260px;        /* fixed drawing area */
      overflow: hidden;     /* clip the line/candles */
      padding: 0 0.5rem 0.5rem;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* bottom panel */
    .paper-panel {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem 0.5rem;
    }
    .paper-box {
      background: rgba(255, 255, 255, 0.01);
      border: 1px solid rgba(255, 255, 255, 0.01);
      border-radius: 12px;
      padding: 0.4rem 0.65rem 0.55rem;
      flex: 1;
      min-height: 54px;
    }
    .paper-label {
      font-size: 0.52rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.35);
      letter-spacing: 0.04em;
    }
    .paper-value {
      margin-top: 2px;
      font-size: 0.78rem;
    }
    .btn-small {
      background: #fff;
      color: #000;
      border: none;
      border-radius: 9999px;
      font-size: 0.55rem;
      padding: 3px 10px;
      cursor: pointer;
    }
    .paper-trades-log {
      background: rgba(255, 255, 255, 0.01);
      border: 1px solid rgba(255, 255, 255, 0.01);
      border-radius: 12px;
      padding: 0.4rem 0.65rem 0.35rem;
      margin: 0 1.25rem 0.5rem;
      min-height: 48px;
      font-size: 0.6rem;
      color: rgba(255, 255, 255, 0.5);
    }
    .paper-trade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2px;
    }
    .paper-side {
      font-size: 0.53rem;
      padding: 2px 6px;
      border-radius: 9999px;
    }
    .paper-side.buy {
      background: rgba(17, 216, 129, 0.12);
      color: #fff;
    }
    .paper-side.sell {
      background: rgba(255, 107, 107, 0.12);
      color: #fff;
    }
    .refresh-bar {
      display: block;
      background: #fff;
      height: 12px;
      border-radius: 9999px;
      margin: 0.3rem 1.25rem 0.5rem;
      position: relative;
      overflow: hidden;
    }
    .refresh-text {
      position: absolute;
      inset: 0;
      font-size: 0.6rem;
      text-align: center;
      line-height: 12px;
      color: #000;
      mix-blend-mode: multiply;
    }
    .foot {
      font-size: 0.5rem;
      color: rgba(255, 255, 255, 0.25);
      padding: 0 1.25rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mode-btn {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 9999px;
      padding: 4px 12px;
      font-size: 0.6rem;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.7);
    }
    .mode-btn.active {
      background: rgba(69, 210, 200, 0.18);
      border-color: rgba(69, 210, 200, 0.35);
      color: #fff;
    }
    @media (max-width: 1020px) {
      .main-row { flex-direction: column; }
      .coin-list { width: 100%; flex-direction: row; }
      .coin-scroll { max-height: 170px; white-space: nowrap; display: flex; gap: 0.5rem; }
      .chart-body { height: 230px; }
      .paper-panel { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="topbar">
      <div id="statusDot" class="status-dot"></div>
      <div class="title">My Coinbase Bot</div>
    </div>

    <div class="main-row">
      <div class="coin-list">
        <input id="search" class="coin-search" placeholder="search coin..." />
        <div id="coinList" class="coin-scroll"></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-left">
            <div id="sym" class="chart-symbol">BTC-USD</div>
            <div id="symPrice" class="chart-price">$0</div>
          </div>
          <div class="chart-tabs">
            <div data-tf="1d" class="chip tf active">1D</div>
            <div data-tf="1w" class="chip tf">1W</div>
            <div data-tf="1m" class="chip tf">1M</div>
            <div data-tf="6m" class="chip tf">6M</div>
            <div data-tf="1y" class="chip tf">1Y</div>
          </div>
          <div class="view-tabs">
            <div data-view="line" class="chip view active">Line</div>
            <div data-view="candles" class="chip view">Candles</div>
          </div>
          <div class="view-tabs">
            <div id="paperBtn" class="mode-btn active">Paper</div>
            <div id="realBtn" class="mode-btn">Real auto: OFF</div>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>

    <div id="paperPanel" class="paper-panel">
      <div class="paper-box">
        <div class="paper-label">paper balance (USD)</div>
        <div style="display:flex;gap:0.3rem;align-items:center;margin-top:3px;">
          <input id="paperBalanceInput" value="1000" style="width:70px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);border-radius:6px;padding:2px 4px;color:#fff;font-size:0.6rem;" />
          <button id="setPaperBalance" class="btn-small">set</button>
        </div>
      </div>
      <div class="paper-box">
        <div class="paper-label">equity now</div>
        <div id="equityNow" class="paper-value">$1,000.00</div>
      </div>
      <div class="paper-box">
        <div class="paper-label">money earned</div>
        <div id="moneyEarned" class="paper-value" style="color:var(--green);">+$0.00</div>
      </div>
      <div class="paper-box">
        <div class="paper-label">% gained</div>
        <div id="pctGained" class="paper-value" style="color:var(--green);">0.00%</div>
        <button id="paperAuto" class="mode-btn" style="margin-top:3px;">paper auto: OFF</button>
      </div>
    </div>

    <div id="paperTradesLog" class="paper-trades-log">no paper trades yet</div>

    <div class="refresh-bar">
      <div class="refresh-text">Refresh</div>
    </div>

    <div class="foot">
      <div id="lastUpdated">updated --:--:--</div>
      <div style="font-size:0.55rem;color:rgba(255,255,255,.3);">live from Coinbase</div>
    </div>
  </div>

  <script>
    const chartCanvas = document.getElementById('chart');
    const ctx = chartCanvas.getContext('2d');

    let state = null;
    let currentSymbol = 'BTC-USD';
    let currentTF = '1d';
    let currentView = 'line';

    function resizeCanvas() {
      const parent = chartCanvas.parentElement;
      chartCanvas.width = parent.clientWidth;
      chartCanvas.height = parent.clientHeight;
    }
    window.addEventListener('resize', () => {
      resizeCanvas();
      if (state) drawChart(lastPoints);
    });

    let lastPoints = [];

    function drawChart(data) {
      if (!data || !data.points) return;
      lastPoints = data;
      resizeCanvas();
      const w = chartCanvas.width;
      const h = chartCanvas.height;
      ctx.clearRect(0, 0, w, h);

      const pts = data.points;
      // padding so line NEVER goes under the border
      const padL = 25, padR = 10, padT = 15, padB = 20;
      const innerW = w - padL - padR;
      const innerH = h - padT - padB;

      // find min/max on CLOSE (index 4)
      let min = Infinity, max = -Infinity;
      pts.forEach(p => {
        const v = p[4] ?? p[1] ?? p[0];
        if (v < min) min = v;
        if (v > max) max = v;
      });
      if (min === max) {
        min -= 1; max += 1;
      }

      if (currentView === 'line') {
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#45d2c8';
        ctx.beginPath();
        pts.forEach((p, i) => {
          const v = p[4] ?? p[1];
          const x = padL + (i / Math.max(pts.length - 1, 1)) * innerW;
          const y = padT + (1 - (v - min) / (max - min)) * innerH;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      } else {
        // candles
        const barW = innerW / Math.max(pts.length, 1) * 0.6;
        pts.forEach((p, i) => {
          const [t, open, high, low, close] = p;
          const x = padL + (i / Math.max(pts.length - 1, 1)) * innerW;
          const toY = val => padT + (1 - (val - min) / (max - min)) * innerH;

          const yHigh = toY(high);
          const yLow = toY(low);
          ctx.strokeStyle = 'rgba(255,255,255,0.15)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, yHigh);
          ctx.lineTo(x, yLow);
          ctx.stroke();

          const yOpen = toY(open);
          const yClose = toY(close);
          const isUp = close >= open;
          ctx.fillStyle = isUp ? '#11d881' : '#ff6b6b';
          ctx.fillRect(x - barW / 2, Math.min(yOpen, yClose), barW, Math.abs(yClose - yOpen) || 3);
        });
      }
    }

    async function fetchState() {
      const res = await fetch('/state');
      const data = await res.json();
      state = data;
      document.getElementById('statusDot').classList.toggle('online', !!data.connected);

      // coins
      const cl = document.getElementById('coinList');
      cl.innerHTML = '';
      data.coins.forEach(c => {
        const div = document.createElement('div');
        div.className = 'coin-item' + (c.symbol === data.selected ? ' active' : '');
        div.onclick = () => {
          currentSymbol = c.symbol;
          loadChart();
        };
        const left = document.createElement('div');
        left.className = 'coin-left';
        left.innerHTML = `<div class="coin-symbol">${c.symbol}</div><div class="coin-price">$${c.price}</div>`;
        const sig = document.createElement('div');
        const s = (c.signal || 'HOLD').toLowerCase();
        sig.className = 'coin-signal ' + (s === 'buy' ? 'buy' : s === 'sell' ? 'sell' : '');
        sig.textContent = (c.signal || 'HOLD') + (c.confidence ? ' - ' + c.confidence + '%' : '');
        div.appendChild(left);
        div.appendChild(sig);
        cl.appendChild(div);
      });

      currentSymbol = data.selected || data.coins[0]?.symbol || 'BTC-USD';
      document.getElementById('sym').textContent = currentSymbol;
      const sel = data.coins.find(c => c.symbol === currentSymbol);
      document.getElementById('symPrice').textContent = sel ? '$' + sel.price : '$0';

      // paper stuff
      document.getElementById('paperBalanceInput').value = data.paper_balance ?? 1000;
      document.getElementById('equityNow').textContent = '$' + (data.paper_equity ?? 0).toFixed(2);
      const pl = data.paper_pl ?? 0;
      const pct = data.paper_pct ?? 0;
      const me = document.getElementById('moneyEarned');
      me.textContent = (pl >= 0 ? '+' : '') + pl.toFixed(2);
      me.style.color = pl >= 0 ? 'var(--green)' : 'var(--red)';
      const pg = document.getElementById('pctGained');
      pg.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
      pg.style.color = pct >= 0 ? 'var(--green)' : 'var(--red)';

      // paper trades
      const log = document.getElementById('paperTradesLog');
      const trades = data.paper_trades || [];
      if (!trades.length) {
        log.textContent = 'no paper trades yet';
      } else {
        log.innerHTML = '';
        trades.forEach(t => {
          const row = document.createElement('div');
          row.className = 'paper-trade-item';
          row.innerHTML = `
            <div><span class="paper-side ${t.side.toLowerCase()}">${t.side}</span> ${t.symbol}</div>
            <div>$${t.price}</div>
            <div style="opacity:.4;font-size:.52rem;">${t.timestamp}</div>
          `;
          log.appendChild(row);
        });
      }

      document.getElementById('lastUpdated').textContent =
        'updated ' + new Date().toLocaleTimeString();

      loadChart(false);
    }

    async function loadChart(showLoader = true) {
      const res = await fetch(`/chart/${encodeURIComponent(currentSymbol)}?tf=${currentTF}`);
      const data = await res.json();
      drawChart(data);
      document.getElementById('sym').textContent = currentSymbol;
      const sel = state?.coins?.find(c => c.symbol === currentSymbol);
      if (sel) document.getElementById('symPrice').textContent = '$' + sel.price;
    }

    document.getElementById('setPaperBalance').onclick = async () => {
      const v = parseFloat(document.getElementById('paperBalanceInput').value || '0');
      await fetch('/set_paper_balance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({balance: v})
      });
      fetchState();
    };

    document.getElementById('paperAuto').onclick = async () => {
      const btn = document.getElementById('paperAuto');
      const isOn = btn.textContent.includes('ON');
      await fetch('/toggle_paper_auto', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: !isOn})
      });
      btn.textContent = 'paper auto: ' + (!isOn ? 'ON' : 'OFF');
      fetchState();
    };

    document.getElementById('paperBtn').onclick = async () => {
      // show paper panel
      document.getElementById('paperPanel').style.display = 'flex';
      document.getElementById('paperTradesLog').style.display = 'block';
      document.getElementById('paperBtn').classList.add('active');
      await fetch('/toggle_mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode: 'paper'})
      });
    };

    document.getElementById('realBtn').onclick = async () => {
      const btn = document.getElementById('realBtn');
      const isOff = btn.textContent.includes('OFF');
      await fetch('/toggle_real_auto', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: isOff})
      });
      btn.textContent = 'Real auto: ' + (isOff ? 'ON' : 'OFF');
    };

    document.querySelectorAll('.tf').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('.tf').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        currentTF = el.dataset.tf;
        loadChart();
      };
    });
    document.querySelectorAll('.view').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        currentView = el.dataset.view;
        drawChart(lastPoints);
      };
    });

    // init
    fetchState();
    setInterval(fetchState, 10000);
  </script>
</body>
</html>
