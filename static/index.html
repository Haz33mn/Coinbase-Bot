<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Coinbase Bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #000000;
        --panel: #121212;
        --panel2: #171717;
        --text: #ffffff;
        --muted: rgba(255, 255, 255, 0.3);
        --accent: #ffffff;
        --line: #40f3d4;
        --danger: #f43f5e;
        --success: #22c55e;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      .shell {
        max-width: 1100px;
        margin: 36px auto 40px;
        background: var(--panel);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.02);
        box-shadow: 0 18px 38px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }
      header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 20px 26px 8px;
      }
      header h1 {
        font-size: 1.05rem;
        font-weight: 600;
        margin: 0;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        margin-right: 4px;
      }
      .status-txt {
        font-size: 0.7rem;
        color: var(--muted);
      }
      .main {
        display: flex;
        gap: 0;
        padding: 0 20px 0;
      }
      .coin-list {
        width: 210px;
        background: rgba(0, 0, 0, 0.18);
        border-radius: 16px;
        padding: 14px 10px 14px 10px;
        margin-right: 18px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 420px;
        overflow-y: auto;
      }
      .search {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 0.65rem;
        color: var(--text);
        outline: none;
      }
      .coin-row {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 7px 9px 6px;
        display: flex;
        justify-content: space-between;
        gap: 6px;
        cursor: pointer;
        transition: 0.12s ease;
      }
      .coin-row.active {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
      }
      .coin-left {
        display: flex;
        flex-direction: column;
      }
      .coin-name {
        font-size: 0.65rem;
      }
      .coin-price {
        font-size: 0.58rem;
        color: var(--muted);
      }
      .signal-pill {
        font-size: 0.52rem;
        padding: 1px 6px 2px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .signal-pill.buy {
        background: rgba(34, 197, 94, 0.12);
        border-color: rgba(34, 197, 94, 0.25);
      }
      .signal-pill.sell {
        background: rgba(244, 63, 94, 0.12);
        border-color: rgba(244, 63, 94, 0.25);
      }
      .chart-side {
        flex: 1;
        background: var(--panel2);
        border-radius: 16px;
        min-height: 360px;
        position: relative;
        display: flex;
        flex-direction: column;
      }
      .chart-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px 2px;
      }
      .pair-title {
        font-weight: 600;
        font-size: 0.7rem;
      }
      .pair-price {
        font-size: 0.6rem;
        color: var(--muted);
      }
      .tf-tabs,
      .mode-tabs,
      .style-tabs {
        display: flex;
        gap: 6px;
      }
      .tf-btn,
      .mode-btn,
      .style-btn {
        background: rgba(255, 255, 255, 0.01);
        border: 1px solid transparent;
        border-radius: 999px;
        padding: 3px 10px 4px;
        font-size: 0.57rem;
        color: var(--muted);
        cursor: pointer;
      }
      .tf-btn.active,
      .mode-btn.active,
      .style-btn.active {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.05);
        color: #fff;
      }
      .chart-body {
        flex: 1;
        position: relative;
        padding: 6px 10px 10px;
      }
      canvas {
        width: 100%;
        height: 100%;
        display: block;
      }
      .refresh-bar {
        margin: 14px 20px 18px;
        background: #ffffff;
        height: 14px;
        border-radius: 999px;
        text-align: center;
        font-size: 0.6rem;
        font-weight: 600;
        line-height: 14px;
        color: #000;
        cursor: pointer;
      }
      .footer-line {
        font-size: 0.5rem;
        color: rgba(255, 255, 255, 0.15);
        padding: 0 22px 14px;
      }
      @media (max-width: 900px) {
        .main {
          flex-direction: column;
        }
        .coin-list {
          flex-direction: row;
          flex-wrap: wrap;
          width: 100%;
          max-height: none;
        }
        .chart-side {
          margin-top: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="status-dot"></div>
        <div>
          <h1>My Coinbase Bot</h1>
          <div class="status-txt">connected to bot</div>
        </div>
      </header>
      <div class="main">
        <div class="coin-list" id="coinList">
          <input
            id="search"
            class="search"
            placeholder="search coin..."
            autocomplete="off"
          />
          <!-- coins will be injected -->
        </div>
        <div class="chart-side">
          <div class="chart-top">
            <div>
              <div class="pair-title" id="pairName">BTC-USD</div>
              <div class="pair-price" id="pairPrice">$0</div>
            </div>
            <div class="tf-tabs">
              <button class="tf-btn active" data-tf="1d">1D</button>
              <button class="tf-btn" data-tf="1w">1W</button>
              <button class="tf-btn" data-tf="1m">1M</button>
              <button class="tf-btn" data-tf="6m">6M</button>
              <button class="tf-btn" data-tf="1y">1Y</button>
            </div>
            <div class="mode-tabs">
              <button class="mode-btn active" data-mode="off">Off</button>
              <button class="mode-btn" data-mode="paper">Paper</button>
              <button class="mode-btn" data-mode="live">Live</button>
            </div>
            <div class="style-tabs">
              <button class="style-btn active" data-style="line">Line</button>
              <button class="style-btn" data-style="candles">Candles</button>
            </div>
          </div>
          <div class="chart-body">
            <canvas id="chartCanvas"></canvas>
            <div
              id="chartError"
              style="
                position: absolute;
                bottom: 7px;
                right: 10px;
                background: rgba(244, 63, 94, 0.12);
                border: 1px solid rgba(244, 63, 94, 0.3);
                border-radius: 14px;
                padding: 2px 10px 2px;
                font-size: 0.5rem;
                color: rgba(255, 255, 255, 0.7);
                display: none;
              "
            >
              fallback data
            </div>
          </div>
        </div>
      </div>
      <div class="refresh-bar" id="refreshBtn">Refresh</div>
      <div class="footer-line" id="lastUpdated">updated --</div>
    </div>
    <script>
      const API_BASE = "";
      const coinListEl = document.getElementById("coinList");
      const pairNameEl = document.getElementById("pairName");
      const pairPriceEl = document.getElementById("pairPrice");
      const refreshBtn = document.getElementById("refreshBtn");
      const lastUpdatedEl = document.getElementById("lastUpdated");
      const chartCanvas = document.getElementById("chartCanvas");
      const chartError = document.getElementById("chartError");
      const tfBtns = document.querySelectorAll(".tf-btn");
      const modeBtns = document.querySelectorAll(".mode-btn");
      const styleBtns = document.querySelectorAll(".style-btn");
      const searchEl = document.getElementById("search");

      let coins = [];
      let selectedSymbol = "BTC-USD";
      let selectedTf = "1d";
      let selectedStyle = "line";

      // chart context setup with HiDPI
      const ctx = chartCanvas.getContext("2d");

      function resizeCanvas() {
        const rect = chartCanvas.parentElement.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        chartCanvas.width = rect.width * dpr;
        chartCanvas.height = 310 * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      async function fetchPrices() {
        const r = await fetch(API_BASE + "/api/prices");
        const data = await r.json();
        coins = data.coins || [];
        renderCoinList();
        // if selected got removed, pick first
        if (!coins.find((c) => c.id === selectedSymbol) && coins.length) {
          selectedSymbol = coins[0].id;
        }
        updateHeader();
        await loadHistory();
        lastUpdatedEl.textContent = "updated " + new Date().toLocaleTimeString();
      }

      function renderCoinList(filter = "") {
        // remove all except search
        const kids = Array.from(coinListEl.children).slice(1);
        kids.forEach((k) => k.remove());

        coins
          .filter((c) =>
            c.id.toLowerCase().includes(filter.toLowerCase().trim())
          )
          .forEach((c) => {
            const row = document.createElement("div");
            row.className = "coin-row" + (c.id === selectedSymbol ? " active" : "");
            row.dataset.id = c.id;

            const left = document.createElement("div");
            left.className = "coin-left";
            const nm = document.createElement("div");
            nm.className = "coin-name";
            nm.textContent = c.id;
            const pr = document.createElement("div");
            pr.className = "coin-price";
            pr.textContent = c.price ? "$" + c.price.toLocaleString() : "$0";
            left.appendChild(nm);
            left.appendChild(pr);

            const pill = document.createElement("div");
            pill.className = "signal-pill";
            pill.textContent = c.signal + " Â· " + (c.confidence || 50) + "%";
            if (c.signal === "BUY") pill.classList.add("buy");
            if (c.signal === "SELL") pill.classList.add("sell");

            row.appendChild(left);
            row.appendChild(pill);

            row.addEventListener("click", () => {
              selectedSymbol = c.id;
              renderCoinList(filter);
              updateHeader();
              loadHistory();
            });

            coinListEl.appendChild(row);
          });
      }

      function updateHeader() {
        const coin = coins.find((c) => c.id === selectedSymbol);
        pairNameEl.textContent = selectedSymbol;
        pairPriceEl.textContent = coin
          ? "$" + (coin.price || 0).toLocaleString()
          : "$0";
      }

      async function loadHistory() {
        resizeCanvas();
        chartError.style.display = "none";
        ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
        const r = await fetch(
          API_BASE + "/api/history/" + selectedSymbol + "?tf=" + selectedTf
        );
        const data = await r.json();
        const candles = data.candles || [];
        if (!data.ok) {
          chartError.style.display = "block";
        }
        drawChart(candles);
      }

      function drawChart(candles) {
        const w = chartCanvas.parentElement.getBoundingClientRect().width;
        const h = 290;
        ctx.clearRect(0, 0, w, h);

        if (!candles.length) return;

        if (selectedStyle === "line") {
          // line
          const prices = candles.map((c) => c.close);
          const max = Math.max(...prices);
          const min = Math.min(...prices);
          const pad = (max - min) * 0.15 || 1;
          const top = max + pad;
          const bottom = min - pad;

          ctx.lineWidth = 2.2;
          ctx.strokeStyle = "rgba(64,243,212,1)";
          ctx.beginPath();
          candles.forEach((c, i) => {
            const x = (i / (candles.length - 1)) * (w - 10) + 4;
            const y = h - ((c.close - bottom) / (top - bottom)) * (h - 18) - 6;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
        } else {
          // candles
          const max = Math.max(...candles.map((c) => c.high));
          const min = Math.min(...candles.map((c) => c.low));
          const pad = (max - min) * 0.15 || 1;
          const top = max + pad;
          const bottom = min - pad;
          const candleW = Math.max(3, (w - 20) / candles.length - 2);

          candles.forEach((c, i) => {
            const x = (i / candles.length) * (w - 10) + 10;
            const isUp = c.close >= c.open;
            const color = isUp ? "#40f3d4" : "#f43f5e";

            // wick
            const highY =
              h - ((c.high - bottom) / (top - bottom)) * (h - 18) - 6;
            const lowY =
              h - ((c.low - bottom) / (top - bottom)) * (h - 18) - 6;
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, highY);
            ctx.lineTo(x, lowY);
            ctx.stroke();

            // body
            const openY =
              h - ((c.open - bottom) / (top - bottom)) * (h - 18) - 6;
            const closeY =
              h - ((c.close - bottom) / (top - bottom)) * (h - 18) - 6;
            const bodyY = Math.min(openY, closeY);
            const bodyH = Math.max(3, Math.abs(closeY - openY));
            ctx.fillStyle = color;
            ctx.fillRect(x - candleW / 2, bodyY, candleW, bodyH);
          });
        }
      }

      // timeframes
      tfBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          tfBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedTf = btn.dataset.tf;
          loadHistory();
        });
      });

      // style
      styleBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          styleBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedStyle = btn.dataset.style;
          loadHistory();
        });
      });

      // mode
      async function setModeOnServer(mode) {
        await fetch(API_BASE + "/api/trade-mode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode }),
        });
      }
      modeBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          modeBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          await setModeOnServer(btn.dataset.mode);
        });
      });

      // search
      searchEl.addEventListener("input", (e) => {
        renderCoinList(e.target.value);
      });

      refreshBtn.addEventListener("click", fetchPrices);

      // initial
      fetchPrices();
      // auto-refresh prices every 30s
      setInterval(fetchPrices, 30000);
    </script>
  </body>
</html>
