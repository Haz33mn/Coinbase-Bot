<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Coinbase Bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #000000;
        --card: #101010;
        --card2: #151515;
        --accent: #ffffff;
        --muted: rgba(255, 255, 255, 0.06);
        --line: #39e6d4;
        --red: #ff6060;
        --green: #06d6a0;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 1.5rem 1.5rem 3rem;
      }
      .app-shell {
        width: min(1200px, 100%);
        background: var(--card);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem 0.5rem;
      }
      .title {
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #16db65;
        display: inline-block;
      }
      .subtitle {
        font-size: 0.65rem;
        opacity: 0.55;
      }
      .mode-buttons {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 999px;
        display: flex;
        gap: 0.25rem;
        padding: 0.25rem;
      }
      .mode-btn {
        border: none;
        background: transparent;
        color: #fff;
        font-size: 0.65rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
        opacity: 0.6;
      }
      .mode-btn.active {
        background: #fff;
        color: #000;
        opacity: 1;
      }
      .content-row {
        display: grid;
        grid-template-columns: 230px 1fr;
        gap: 0.85rem;
        padding: 0 1.5rem 1rem;
      }
      .coin-list {
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 14px;
        overflow-y: auto;
        max-height: 450px;
      }
      .search {
        padding: 0.5rem 0.7rem;
      }
      .search input {
        width: 100%;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 999px;
        padding: 0.35rem 0.7rem;
        color: #fff;
        font-size: 0.7rem;
      }
      .coin {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.7rem;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.15s;
      }
      .coin:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .coin.active {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .coin-name {
        font-size: 0.7rem;
      }
      .coin-price {
        font-size: 0.65rem;
        opacity: 0.6;
      }
      .signal-pill {
        font-size: 0.55rem;
        padding: 0.1rem 0.45rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
      }
      .signal-buy {
        background: rgba(6, 214, 160, 0.12);
        color: #06d6a0;
      }
      .signal-sell {
        background: rgba(255, 96, 96, 0.12);
        color: #ff6060;
      }
      .chart-card {
        background: rgba(0, 0, 0, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.02);
        border-radius: 14px;
        height: 450px;
        display: flex;
        flex-direction: column;
      }
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 1rem 0.4rem;
      }
      .chart-title {
        font-size: 0.7rem;
        font-weight: 600;
      }
      .tf-buttons,
      .style-buttons {
        display: flex;
        gap: 0.4rem;
      }
      .tf-btn,
      .style-btn {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.01);
        border-radius: 999px;
        font-size: 0.6rem;
        padding: 0.3rem 0.55rem;
        cursor: pointer;
        color: #fff;
        opacity: 0.5;
      }
      .tf-btn.active,
      .style-btn.active {
        opacity: 1;
        background: #fff;
        color: #000;
      }
      .chart-body {
        flex: 1;
        position: relative;
      }
      canvas {
        width: 100%;
        height: 100%;
      }
      .footer {
        padding: 0.45rem 1.5rem 1rem;
      }
      .refresh-btn {
        width: 100%;
        background: #ffffff;
        color: #000;
        border: none;
        border-radius: 999px;
        padding: 0.4rem;
        font-weight: 600;
        cursor: pointer;
      }
      .updated-small {
        font-size: 0.6rem;
        opacity: 0.45;
        margin-top: 0.3rem;
      }
      .paper-panel {
        font-size: 0.6rem;
        text-align: right;
        line-height: 1.1;
      }
      .pnl-green {
        color: #06d6a0;
      }
      .pnl-red {
        color: #ff6060;
      }
      @media (max-width: 900px) {
        .content-row {
          grid-template-columns: 1fr;
        }
        .chart-card {
          height: 420px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div>
          <div class="title">
            My Coinbase Bot
            <span class="dot" id="connDot"></span>
          </div>
          <div class="subtitle">connected to bot</div>
        </div>
        <div class="paper-panel">
          <div>mode: <span id="modeLabel">off</span></div>
          <div>paper equity: <span id="paperEquity">$0.00</span></div>
          <div>paper P/L: <span id="paperPnl" class="pnl-green">$0.00</span></div>
        </div>
        <div class="mode-buttons">
          <button class="mode-btn active" data-mode="off">Off</button>
          <button class="mode-btn" data-mode="paper">Paper</button>
          <button class="mode-btn" data-mode="live">Live</button>
        </div>
      </header>

      <div class="content-row">
        <div class="coin-list">
          <div class="search">
            <input id="searchInput" placeholder="search coin..." />
          </div>
          <div id="coinContainer"></div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title" id="chartTitle">BTC-USD</div>
              <div style="font-size: 0.6rem; opacity: 0.5" id="chartPrice">$0</div>
            </div>
            <div class="tf-buttons">
              <button class="tf-btn active" data-tf="1D">1D</button>
              <button class="tf-btn" data-tf="1W">1W</button>
              <button class="tf-btn" data-tf="1M">1M</button>
              <button class="tf-btn" data-tf="6M">6M</button>
              <button class="tf-btn" data-tf="1Y">1Y</button>
            </div>
            <div class="style-buttons">
              <button class="style-btn active" data-style="line">Line</button>
              <button class="style-btn" data-style="candles">Candles</button>
            </div>
          </div>
          <div class="chart-body">
            <canvas id="chartCanvas"></canvas>
          </div>
        </div>
      </div>

      <div class="footer">
        <button class="refresh-btn" id="refreshBtn">Refresh</button>
        <div class="updated-small" id="updatedAt">updated …</div>
      </div>
    </div>

    <script>
      const coinContainer = document.getElementById("coinContainer");
      const chartCanvas = document.getElementById("chartCanvas");
      const ctx = chartCanvas.getContext("2d");
      const modeButtons = document.querySelectorAll(".mode-btn");
      const tfButtons = document.querySelectorAll(".tf-btn");
      const styleButtons = document.querySelectorAll(".style-btn");
      const chartTitle = document.getElementById("chartTitle");
      const chartPrice = document.getElementById("chartPrice");
      const updatedAt = document.getElementById("updatedAt");
      const modeLabel = document.getElementById("modeLabel");
      const paperEquity = document.getElementById("paperEquity");
      const paperPnl = document.getElementById("paperPnl");
      const connDot = document.getElementById("connDot");

      let prices = {};
      let filteredCoins = [];
      let selectedSymbol = "BTC-USD";
      let currentTF = "1D";
      let currentStyle = "line";
      let currentMode = "off";
      let chartData = [];

      function resizeCanvas() {
        const rect = chartCanvas.getBoundingClientRect();
        chartCanvas.width = rect.width * window.devicePixelRatio;
        chartCanvas.height = rect.height * window.devicePixelRatio;
        ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
        drawChart();
      }
      window.addEventListener("resize", resizeCanvas);

      function renderCoinList() {
        coinContainer.innerHTML = "";
        filteredCoins.forEach((sym) => {
          const price = prices[sym] ?? 0;
          const div = document.createElement("div");
          div.className = "coin" + (sym === selectedSymbol ? " active" : "");
          div.innerHTML = `
            <div>
              <div class="coin-name">${sym}</div>
              <div class="coin-price">$${price.toLocaleString()}</div>
            </div>
            <span class="signal-pill">HOLD • 50%</span>
          `;
          div.addEventListener("click", () => {
            selectedSymbol = sym;
            renderCoinList();
            loadHistory();
          });
          coinContainer.appendChild(div);
        });
      }

      async function loadPrices() {
        try {
          const r = await fetch("/prices");
          const data = await r.json();
          prices = data.prices || {};
          filteredCoins = Object.keys(prices);
          if (!filteredCoins.includes(selectedSymbol) && filteredCoins.length) {
            selectedSymbol = filteredCoins[0];
          }
          renderCoinList();
          chartTitle.textContent = selectedSymbol;
          chartPrice.textContent = "$" + (prices[selectedSymbol] || 0).toLocaleString();
          updatedAt.textContent = "updated " + (data.updated || "");
          connDot.style.background = "#16db65";
        } catch (err) {
          connDot.style.background = "#ff6060";
        }
      }

      async function loadHistory() {
        try {
          const r = await fetch(`/history/${selectedSymbol}?tf=${currentTF}`);
          const data = await r.json();
          chartData = data.candles || [];
          drawChart();
        } catch (err) {
          chartData = [];
          drawChart();
        }
      }

      function drawChart() {
        const w = chartCanvas.width / window.devicePixelRatio;
        const h = chartCanvas.height / window.devicePixelRatio;
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "transparent";
        ctx.fillRect(0, 0, w, h);

        if (!chartData || chartData.length === 0) {
          ctx.fillStyle = "rgba(255,255,255,0.12)";
          ctx.font = "12px system-ui";
          ctx.fillText("no data…", 12, 20);
          return;
        }

        const values = chartData.map((c) => c.c);
        const max = Math.max(...values);
        const min = Math.min(...values);
        const pad = 20;
        const usableW = w - pad * 2;
        const usableH = h - pad * 2;

        if (currentStyle === "line") {
          ctx.strokeStyle = "#39e6d4";
          ctx.lineWidth = 1.6;
          ctx.beginPath();
          chartData.forEach((c, i) => {
            const x = pad + (i / Math.max(1, chartData.length - 1)) * usableW;
            const y = pad + (1 - (c.c - min) / (max - min || 1)) * usableH;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
        } else {
          // candles
          const barW = Math.max(2, usableW / chartData.length - 1);
          chartData.forEach((c, i) => {
            const x = pad + (i / Math.max(1, chartData.length - 1)) * usableW;
            const openY = pad + (1 - (c.o - min) / (max - min || 1)) * usableH;
            const closeY = pad + (1 - (c.c - min) / (max - min || 1)) * usableH;
            const highY = pad + (1 - (c.h - min) / (max - min || 1)) * usableH;
            const lowY = pad + (1 - (c.l - min) / (max - min || 1)) * usableH;
            const up = c.c >= c.o;
            ctx.strokeStyle = up ? "#06d6a0" : "#ff6060";
            ctx.beginPath();
            ctx.moveTo(x, highY);
            ctx.lineTo(x, lowY);
            ctx.stroke();
            ctx.fillStyle = up ? "#06d6a0" : "#ff6060";
            const rectY = Math.min(openY, closeY);
            const rectH = Math.abs(closeY - openY);
            ctx.fillRect(x - barW / 2, rectY, barW, rectH || 2);
          });
        }
      }

      // mode switching
      modeButtons.forEach((btn) => {
        btn.addEventListener("click", async () => {
          modeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const mode = btn.dataset.mode;
          currentMode = mode;
          modeLabel.textContent = mode;
          await fetch("/trade-mode", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mode }),
          });
        });
      });

      // tf switching
      tfButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          tfButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentTF = btn.dataset.tf;
          loadHistory();
        });
      });

      // style switching
      styleButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          styleButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentStyle = btn.dataset.style;
          drawChart();
        });
      });

      // refresh
      document.getElementById("refreshBtn").addEventListener("click", async () => {
        await loadPrices();
        await loadHistory();
        await loadPaperStats();
      });

      // search filter
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const q = e.target.value.toLowerCase();
        filteredCoins = Object.keys(prices).filter((s) => s.toLowerCase().includes(q));
        if (!filteredCoins.includes(selectedSymbol) && filteredCoins.length) {
          selectedSymbol = filteredCoins[0];
        }
        renderCoinList();
      });

      async function loadPaperStats() {
        try {
          const r = await fetch("/paper-stats");
          const data = await r.json();
          paperEquity.textContent = "$" + data.equity.toLocaleString();
          const pnlEl = paperPnl;
          pnlEl.textContent = (data.pnl >= 0 ? "+" : "") + "$" + data.pnl.toFixed(2);
          pnlEl.className = data.pnl >= 0 ? "pnl-green" : "pnl-red";
        } catch (err) {
          // ignore
        }
      }

      async function pingBot() {
        // makes the backend actually trade in paper mode
        await fetch("/run-bot", { method: "POST" }).catch(() => {});
      }

      // boot
      (async () => {
        await loadPrices();
        await loadHistory();
        await loadPaperStats();
        resizeCanvas();
      })();

      // intervals
      setInterval(loadPrices, 20000);
      setInterval(loadPaperStats, 25000);
      setInterval(pingBot, 25000);
    </script>
  </body>
</html>
