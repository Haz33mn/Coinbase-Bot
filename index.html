<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --fg: #ffffff;
      --card: rgba(12, 12, 12, 0.85);
      --border: rgba(255, 255, 255, 0.07);
      --accent: #ffffff;
      --accent-soft: rgba(255, 255, 255, 0.08);
      --muted: rgba(255, 255, 255, 0.45);
      --danger: #f43f5e;
      --success: #22c55e;
      --chartbg: rgba(255, 255, 255, 0.02);
    }
    [data-theme="light"] {
      --bg: #f8fafc;
      --fg: #0f172a;
      --card: #ffffff;
      --border: rgba(15, 23, 42, 0.08);
      --accent: #0f172a;
      --accent-soft: rgba(15, 23, 42, 0.04);
      --muted: rgba(15, 23, 42, 0.6);
      --chartbg: rgba(15, 23, 42, 0.03);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem 1rem 3.5rem;
      transition: background .2s, color .2s;
    }
    .app {
      width: min(1100px, 100%);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1.2rem;
      box-shadow: 0 18px 35px rgba(0,0,0,0.35);
      padding: 1.3rem 1.3rem 1.1rem;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      font-size: .7rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      padding: .3rem .75rem;
      color: var(--muted);
    }
    .dot {
      width: .45rem;
      height: .45rem;
      border-radius: 999px;
      background: #22c55e;
    }
    .actions {
      display: flex;
      gap: .5rem;
      align-items: center;
    }
    #settingsBtn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: .75rem;
      padding: .4rem .8rem;
      font-size: .7rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: .35rem;
    }
    #settingsMenu {
      position: absolute;
      right: 1.3rem;
      top: 3.6rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: .75rem;
      padding: .45rem;
      width: 180px;
      box-shadow: 0 14px 25px rgba(0,0,0,.35);
      display: none;
      z-index: 50;
    }
    #settingsMenu button {
      width: 100%;
      background: transparent;
      border: 1px solid transparent;
      color: var(--fg);
      padding: .35rem .4rem;
      text-align: left;
      border-radius: .4rem;
      font-size: .7rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    #settingsMenu button.active {
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.18);
    }
    .layout {
      display: flex;
      gap: 1.1rem;
      margin-top: 1rem;
    }
    .list {
      width: 32%;
      display: flex;
      flex-direction: column;
      gap: .4rem;
      max-height: 345px;
      overflow-y: auto;
      padding-right: .15rem;
    }
    .search {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: .55rem;
      padding: .3rem .5rem;
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .search input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--fg);
      font-size: .7rem;
      width: 100%;
    }
    .coin-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .4rem;
      padding: .4rem .5rem .4rem .6rem;
      border-radius: .6rem;
      cursor: pointer;
      transition: background .1s;
    }
    .coin-row:hover {
      background: rgba(255,255,255,.05);
    }
    .coin-row.active {
      background: rgba(255,255,255,.16);
      outline: 1px solid rgba(255,255,255,.26);
    }
    .coin-left {
      display: flex;
      flex-direction: column;
      gap: .15rem;
    }
    .coin-symbol {
      font-size: .7rem;
      font-weight: 600;
    }
    .coin-price {
      font-size: .62rem;
      color: var(--muted);
    }
    .coin-right {
      display: flex;
      gap: .35rem;
      align-items: center;
    }
    .tag {
      font-size: .55rem;
      padding: 2px 8px 2px 8px;
      border-radius: 999px;
      font-weight: 600;
      white-space: nowrap;
    }
    .buy { background: rgba(34,197,94,.12); color: #22c55e; }
    .sell { background: rgba(244,63,94,.11); color: #f43f5e; }
    .hold { background: rgba(255,255,255,.1); color: #fff; }
    .score {
      font-size: .55rem;
      color: var(--muted);
      text-align: right;
    }
    .chart-area {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: .75rem .75rem .6rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      min-height: 285px;
      position: relative;
    }
    .chart-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .coin-title {
      display: flex;
      flex-direction: column;
      gap: .25rem;
    }
    .coin-title small { color: var(--muted); font-size: .6rem; }
    .ranges, .types {
      display: flex;
      gap: .35rem;
      flex-wrap: wrap;
    }
    .btn-sm {
      background: rgba(255,255,255,.015);
      border: 1px solid transparent;
      border-radius: .6rem;
      padding: .18rem .6rem;
      font-size: .62rem;
      cursor: pointer;
      color: var(--fg);
    }
    .btn-sm.active {
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.25);
    }
    .canvas-box {
      background: var(--chartbg);
      border-radius: .8rem;
      overflow: hidden;
      min-height: 200px;
    }
    canvas {
      width: 100%;
      height: 200px;
      display: block;
    }
    .chart-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .6rem;
      color: var(--muted);
    }
    .err-bar {
      position: absolute;
      bottom: 2.1rem;
      right: .9rem;
      background: rgba(244,63,94,.12);
      border: 1px solid rgba(244,63,94,.2);
      border-radius: .35rem;
      font-size: .58rem;
      padding: .2rem .45rem;
      display: none;
    }
    .refresh-btn {
      width: 100%;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: .7rem;
      padding: .5rem 0;
      margin-top: .9rem;
      font-weight: 600;
      cursor: pointer;
    }
    @media (max-width: 880px) {
      .layout { flex-direction: column; }
      .list { width: 100%; max-height: 170px; flex-wrap: wrap; }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="app">
    <div class="card" id="rootCard">
      <div class="topbar">
        <div>
          <h1>My Coinbase Bot</h1>
          <div class="status-pill" id="statusPill">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">connecting‚Ä¶</span>
          </div>
        </div>
        <div class="actions">
          <button id="settingsBtn">‚öôÔ∏é Settings</button>
        </div>
        <div id="settingsMenu">
          <button data-mode="dark" class="active">Dark <span>‚óè</span></button>
          <button data-mode="light">Light <span></span></button>
          <button id="toggleAudit">Audit log: on <span></span></button>
        </div>
      </div>

      <div class="layout">
        <!-- LEFT LIST -->
        <div class="list">
          <div class="search">
            <span style="font-size:.7rem;opacity:.6;">üîé</span>
            <input id="searchInput" placeholder="search coin‚Ä¶" />
          </div>
          <div id="coinList"></div>
        </div>

        <!-- RIGHT CHART -->
        <div class="chart-area">
          <div class="chart-head">
            <div class="coin-title">
              <div id="chartSymbol">Select a coin</div>
              <small id="chartPrice">‚Äî</small>
            </div>
            <div style="display:flex;gap:.45rem;align-items:center;">
              <div class="ranges">
                <button class="btn-sm active" data-range="24h">24h</button>
                <button class="btn-sm" data-range="1m">1M</button>
                <button class="btn-sm" data-range="6m">6M</button>
                <button class="btn-sm" data-range="1y">1Y</button>
              </div>
              <div class="types">
                <button class="btn-sm active" data-type="line">Line</button>
                <button class="btn-sm" data-type="candles">Candles</button>
              </div>
            </div>
          </div>
          <div class="canvas-box">
            <canvas id="chartCanvas" width="600" height="200"></canvas>
          </div>
          <div class="chart-footer">
            <span id="chartUpdated">loading‚Ä¶</span>
            <span id="chartSignal">signal: ‚Äî</span>
          </div>
          <div class="err-bar" id="chartError">could not load history, showing mock</div>
        </div>
      </div>

      <button class="refresh-btn" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <script>
    // ----------- CONFIG -----------
    const API_BASE = "";             // same origin
    const PRICES_URL = "/prices";
    const HISTORY_URL = "/history";

    // < 0.35% movement = HOLD
    const DEAD_BAND = 0.35;
    // force HOLD when no history
    const FAIL_SAFE_HOLD = true;

    let currentCoins = [];
    let filteredCoins = [];
    let selectedSymbol = null;
    let selectedRange = "24h";
    let selectedType = "line";
    let auditEnabled = true;

    const coinListEl = document.getElementById("coinList");
    const searchInput = document.getElementById("searchInput");
    const chartSymbolEl = document.getElementById("chartSymbol");
    const chartPriceEl = document.getElementById("chartPrice");
    const chartUpdatedEl = document.getElementById("chartUpdated");
    const chartSignalEl = document.getElementById("chartSignal");
    const chartErrorEl = document.getElementById("chartError");
    const refreshBtn = document.getElementById("refreshBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsMenu = document.getElementById("settingsMenu");
    const statusText = document.getElementById("statusText");
    const statusDot = document.getElementById("statusDot");
    const chartCanvas = document.getElementById("chartCanvas");
    const ctx = chartCanvas.getContext("2d");

    // -------------- MOCK for when backend can't hit Coinbase --------------
    function buildMockHistory(price) {
      const points = [];
      const base = price || 100;
      for (let i = 0; i < 48; i++) {
        const wobble = Math.sin(i/4) * (base * 0.0025);
        points.push({
          t: i,
          o: base + wobble * 0.4,
          h: base + wobble * 0.8 + 1.5,
          l: base + wobble * 0.2 - 1.5,
          c: base + wobble
        });
      }
      return points;
    }

    // -------------- RENDER LIST --------------
    function renderCoinList(list) {
      coinListEl.innerHTML = "";
      list.forEach((c, idx) => {
        const row = document.createElement("div");
        row.className = "coin-row" + (idx === 0 ? " active" : "");
        row.dataset.symbol = c.symbol;

        const left = document.createElement("div");
        left.className = "coin-left";
        const sym = document.createElement("div");
        sym.className = "coin-symbol";
        sym.textContent = c.symbol;
        const price = document.createElement("div");
        price.className = "coin-price";
        price.textContent = c.price_display;
        left.appendChild(sym);
        left.appendChild(price);

        const right = document.createElement("div");
        right.className = "coin-right";

        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = c.signal.label;
        if (c.signal.label === "BUY") tag.classList.add("buy");
        else if (c.signal.label === "SELL") tag.classList.add("sell");
        else tag.classList.add("hold");

        const score = document.createElement("span");
        score.className = "score";
        score.textContent = c.signal.conf + "%";

        right.appendChild(tag);
        right.appendChild(score);

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener("click", () => {
          document.querySelectorAll(".coin-row").forEach(r => r.classList.remove("active"));
          row.classList.add("active");
          selectCoin(c.symbol);
        });

        coinListEl.appendChild(row);
      });
    }

    // -------------- DRAW CHARTS --------------
    function clearCanvas() {
      ctx.clearRect(0,0,chartCanvas.width,chartCanvas.height);
      ctx.fillStyle = "transparent";
    }
    function drawLine(data) {
      clearCanvas();
      if (!data || data.length === 0) return;
      const w = chartCanvas.width;
      const h = chartCanvas.height;
      const prices = data.map(p => p.c);
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const pad = 12;
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = "#22c55e";
      ctx.beginPath();
      data.forEach((p, i) => {
        const x = pad + (i / Math.max(1, data.length-1)) * (w - pad*2);
        const norm = (p.c - min) / Math.max(0.0001, (max - min));
        const y = h - pad - norm * (h - pad*2);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }
    function drawCandles(data) {
      clearCanvas();
      if (!data || data.length === 0) return;
      const w = chartCanvas.width;
      const h = chartCanvas.height;
      const pad = 12;
      const highs = data.map(d => d.h);
      const lows = data.map(d => d.l);
      const min = Math.min(...lows);
      const max = Math.max(...highs);
      const candleW = Math.max(3, (w - pad*2) / data.length - 1);

      data.forEach((d, i) => {
        const x = pad + i * ((w - pad*2) / data.length) + 1;
        const scale = (val) => {
          const norm = (val - min) / Math.max(0.0001, (max-min));
          return h - pad - norm * (h - pad*2);
        };
        const yHigh = scale(d.h);
        const yLow = scale(d.l);
        const yOpen = scale(d.o);
        const yClose = scale(d.c);
        const rising = d.c >= d.o;
        ctx.strokeStyle = rising ? "#22c55e" : "#f43f5e";
        ctx.fillStyle = rising ? "rgba(34,197,94,.35)" : "rgba(244,63,94,.35)";
        // wick
        ctx.beginPath();
        ctx.moveTo(x + candleW/2, yHigh);
        ctx.lineTo(x + candleW/2, yLow);
        ctx.stroke();
        // body
        const bodyY = Math.min(yOpen, yClose);
        const bodyH = Math.max(3, Math.abs(yClose - yOpen));
        ctx.fillRect(x, bodyY, candleW, bodyH);
      });
    }

    // -------------- SIGNAL LOGIC --------------
    function buildSignalFromHistory(history) {
      if (!history || history.length < 2) {
        return FAIL_SAFE_HOLD
          ? {label:"HOLD", conf:50}
          : {label:"BUY", conf:50};
      }
      const first = history[0].c;
      const last = history[history.length-1].c;
      const pct = ((last - first) / first) * 100;

      // dead band so we don't flip every penny
      if (Math.abs(pct) < DEAD_BAND) {
        return {label: "HOLD", conf:50};
      }
      if (pct >= DEAD_BAND) {
        // cap confidence
        const conf = Math.min(90, Math.max(55, Math.abs(pct)*2));
        return {label:"BUY", conf: Math.round(conf)};
      } else {
        const conf = Math.min(90, Math.max(55, Math.abs(pct)*2));
        return {label:"SELL", conf: Math.round(conf)};
      }
    }

    // -------------- FETCH PRICES --------------
    async function fetchPrices() {
      try {
        const res = await fetch(PRICES_URL);
        if (!res.ok) throw new Error("prices not ok");
        const data = await res.json();
        // expect { "ETH-USD": 3800, ... } or similar
        const entries = Object.entries(data);
        let coins = entries.map(([symbol, price]) => {
          const priceNum = Number(price);
          return {
            symbol,
            price: priceNum,
            price_display: "$" + Number(priceNum).toLocaleString(),
            // temp signal, we'll rebuild after fetching chart per coin
            signal: {label:"HOLD", conf:50}
          };
        });
        // just sort by symbol first
        coins.sort((a,b) => a.symbol.localeCompare(b.symbol));
        return coins;
      } catch (e) {
        console.log("prices failed, using mock", e);
        return [
          {symbol:"BTC-USD", price: 110000, price_display:"$110,000", signal:{label:"HOLD", conf:50}},
          {symbol:"ETH-USD", price: 3850, price_display:"$3,850", signal:{label:"HOLD", conf:50}},
          {symbol:"SOL-USD", price: 186, price_display:"$186", signal:{label:"HOLD", conf:50}},
          {symbol:"ADA-USD", price: 0.6, price_display:"$0.60", signal:{label:"HOLD", conf:50}},
          {symbol:"DOGE-USD", price: 0.18, price_display:"$0.18", signal:{label:"HOLD", conf:50}},
          {symbol:"LTC-USD", price: 100, price_display:"$100", signal:{label:"HOLD", conf:50}},
        ];
      }
    }

    // -------------- FETCH HISTORY --------------
    async function fetchHistory(symbol, range) {
      try {
        const url = `${HISTORY_URL}?symbol=${encodeURIComponent(symbol)}&range=${encodeURIComponent(range)}&type=ohlc`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("history bad");
        const data = await res.json();
        // expect array of ohlc
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error("no history array, fallback");
        }
        return data;
      } catch (e) {
        console.log("history fail, using mock", e);
        chartErrorEl.style.display = "block";
        // try to find price of selected
        const coin = currentCoins.find(c => c.symbol === symbol);
        return buildMockHistory(coin ? coin.price : 100);
      }
    }

    // -------------- SELECT COIN --------------
    async function selectCoin(symbol) {
      selectedSymbol = symbol;
      chartSymbolEl.textContent = symbol;
      const coin = currentCoins.find(c => c.symbol === symbol);
      chartPriceEl.textContent = coin ? coin.price_display : "‚Äî";
      chartErrorEl.style.display = "none";
      chartUpdatedEl.textContent = "loading‚Ä¶";

      const history = await fetchHistory(symbol, selectedRange);
      const signal = buildSignalFromHistory(history);
      chartSignalEl.textContent = `signal: ${signal.label} ‚Ä¢ ${signal.conf}%`;
      // update coin in list too
      if (coin) coin.signal = signal;
      renderCoinList(filteredCoins.length ? filteredCoins : currentCoins);

      // draw
      if (selectedType === "line") drawLine(history);
      else drawCandles(history);

      chartUpdatedEl.textContent = "updated " + new Date().toLocaleTimeString();
    }

    // -------------- INITIAL LOAD --------------
    async function loadAll() {
      statusText.textContent = "loading prices‚Ä¶";
      statusDot.style.background = "#f97316";
      const coins = await fetchPrices();
      // fetch history for each coin only for signal ranking (first 10 to avoid spam)
      const topToAnalyze = coins.slice(0, 10);
      for (let c of topToAnalyze) {
        const hist = await fetchHistory(c.symbol, "24h");
        c.signal = buildSignalFromHistory(hist);
      }
      // now rank: best performing = BUY highest conf first, then holds, then sells
      coins.sort((a,b) => {
        const order = {BUY:0, HOLD:1, SELL:2};
        const diff = order[a.signal.label] - order[b.signal.label];
        if (diff !== 0) return diff;
        return b.signal.conf - a.signal.conf;
      });

      currentCoins = coins;
      filteredCoins = [];
      renderCoinList(coins);
      if (coins.length) await selectCoin(coins[0].symbol);

      statusText.textContent = "connected to bot";
      statusDot.style.background = "#22c55e";
    }

    // -------------- REFRESH --------------
    refreshBtn.addEventListener("click", loadAll);
    setInterval(loadAll, 10000); // auto reload every 10s

    // -------------- SEARCH --------------
    searchInput.addEventListener("input", (e) => {
      const q = e.target.value.toUpperCase().trim();
      if (!q) {
        filteredCoins = [];
        return renderCoinList(currentCoins);
      }
      filteredCoins = currentCoins.filter(c => c.symbol.includes(q));
      renderCoinList(filteredCoins);
    });

    // -------------- RANGE & TYPE BUTTONS --------------
    document.querySelectorAll(".ranges .btn-sm").forEach(btn => {
      btn.addEventListener("click", async () => {
        document.querySelectorAll(".ranges .btn-sm").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedRange = btn.dataset.range;
        if (selectedSymbol) await selectCoin(selectedSymbol);
      });
    });
    document.querySelectorAll(".types .btn-sm").forEach(btn => {
      btn.addEventListener("click", async () => {
        document.querySelectorAll(".types .btn-sm").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedType = btn.dataset.type;
        if (selectedSymbol) await selectCoin(selectedSymbol);
      });
    });

    // -------------- SETTINGS --------------
    settingsBtn.addEventListener("click", () => {
      settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", (e) => {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.style.display = "none";
      }
    });
    settingsMenu.querySelectorAll("button[data-mode]").forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.mode;
        document.body.setAttribute("data-theme", mode);
        settingsMenu.querySelectorAll("button[data-mode]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });
    document.getElementById("toggleAudit").addEventListener("click", (e) => {
      auditEnabled = !auditEnabled;
      e.target.textContent = auditEnabled ? "Audit log: on" : "Audit log: off";
    });

    // -------------- GO --------------
    loadAll();
  </script>
</body>
</html>
