<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --panel: #101214;
      --panel-alt: #16191d;
      --text: #ffffff;
      --muted: rgba(255, 255, 255, 0.35);
      --accent: #ffffff;
      --sell: #ff4d4f;
      --buy: #52c41a;
      --hold: rgba(255, 255, 255, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem 0.8rem 3rem;
    }

    .shell {
      width: min(1180px, 100%);
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.4rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.1rem 1.5rem 0;
      gap: 1rem;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #4ade80;
      display: inline-block;
      margin-right: 0.35rem;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1rem;
      padding: 1.1rem 1.5rem 0;
    }

    /* coin list */
    .coin-list-box {
      background: var(--panel-alt);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 1rem;
      overflow: hidden;
    }

    .search-box {
      padding: 0.7rem 0.9rem 0;
    }

    .search-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 999px;
      padding: 0.45rem 0.75rem;
      color: var(--text);
      font-size: 0.75rem;
      outline: none;
    }

    .coin-list {
      max-height: 385px;
      overflow-y: auto;
      padding: 0.4rem 0.25rem 0.6rem;
    }

    .coin-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      padding: 0.55rem 0.5rem 0.55rem 0.75rem;
      border-radius: 0.65rem;
      cursor: pointer;
      transition: background 0.12s;
    }

    .coin-row:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .coin-row.active {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .coin-name {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .coin-symbol {
      font-size: 0.72rem;
    }

    .coin-price {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .signal-pill {
      font-size: 0.55rem;
      padding: 0.09rem 0.45rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .signal-buy {
      background: rgba(82, 196, 26, 0.15);
      color: #79ff70;
    }

    .signal-sell {
      background: rgba(255, 77, 79, 0.12);
      color: #ff8a8c;
    }

    .signal-hold {
      background: rgba(255, 255, 255, 0.02);
      color: #ffffffb3;
    }

    /* chart area */
    .chart-box {
      background: #0e1012;
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.02);
      padding: 1rem 1.1rem 0.3rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      min-height: 380px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-title-block small {
      color: var(--muted);
      font-size: 0.67rem;
      display: block;
    }

    .chart-title-block h2 {
      margin: 0;
      font-size: 0.9rem;
    }

    .chart-buttons {
      display: flex;
      gap: 0.35rem;
    }

    .tiny-btn {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.02);
      color: var(--text);
      font-size: 0.6rem;
      border-radius: 999px;
      padding: 0.22rem 0.55rem 0.2rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .tiny-btn.active {
      background: rgba(255, 255, 255, 0.14);
      opacity: 1;
    }

    .chart-canvas-wrap {
      background: #0b0c0f;
      border: 1px solid rgba(255, 255, 255, 0.02);
      border-radius: 0.9rem;
      overflow: hidden;
      height: 270px;
      position: relative;
    }

    #chartCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .chart-msg {
      position: absolute;
      right: 0.7rem;
      bottom: 0.6rem;
      font-size: 0.55rem;
      background: rgba(255, 77, 79, 0.12);
      border: 1px solid rgba(255, 77, 79, 0.2);
      border-radius: 999px;
      padding: 0.15rem 0.55rem 0.2rem;
      color: #ff999b;
    }

    .footer-bar {
      margin-top: 1.05rem;
      padding: 0 1.5rem 1rem;
    }

    .refresh-bar {
      width: 100%;
      background: #ffffff;
      color: #0f172a;
      text-align: center;
      padding: 0.45rem 0;
      border-radius: 999px;
      font-size: 0.68rem;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    .update-time {
      text-align: right;
      font-size: 0.55rem;
      color: rgba(255, 255, 255, 0.35);
      margin-top: 0.35rem;
    }

    @media (max-width: 930px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .coin-list {
        max-height: 220px;
      }
      .chart-canvas-wrap {
        height: 240px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <h1>My Coinbase Bot</h1>
      <div style="font-size:0.62rem;color:var(--muted);display:flex;align-items:center;gap:.25rem;">
        <span class="status-dot"></span>connected to bot
      </div>
    </div>

    <div class="main-grid">
      <div class="coin-list-box">
        <div class="search-box">
          <input id="search" class="search-input" placeholder="search coin..." />
        </div>
        <div id="coinList" class="coin-list"></div>
      </div>

      <div class="chart-box">
        <div class="chart-header">
          <div class="chart-title-block">
            <h2 id="coinTitle">Select a coin</h2>
            <small id="coinPrice">$0.00</small>
          </div>
          <div class="chart-buttons">
            <button class="tiny-btn active" data-range="24h">24h</button>
            <button class="tiny-btn" data-range="1M">1M</button>
            <button class="tiny-btn" data-range="6M">6M</button>
            <button class="tiny-btn" data-range="1Y">1Y</button>
            <button class="tiny-btn active" data-mode="line" style="margin-left:0.4rem;">Line</button>
            <button class="tiny-btn" data-mode="candles">Candles</button>
          </div>
        </div>

        <div class="chart-canvas-wrap">
          <canvas id="chartCanvas"></canvas>
          <div id="chartMsg" class="chart-msg" style="display:none;"></div>
        </div>

        <div class="update-time" id="updatedAt">updated --:--:--</div>
      </div>
    </div>

    <div class="footer-bar">
      <button id="refreshBtn" class="refresh-bar">Refresh</button>
    </div>
  </div>

  <script>
    const API_BASE = "";
    let coins = [];
    let selectedSymbol = null;
    let currentRange = "24h";
    let currentMode = "line";

    const coinListEl = document.getElementById("coinList");
    const chartCanvas = document.getElementById("chartCanvas");
    const ctx = chartCanvas.getContext("2d");
    const chartMsg = document.getElementById("chartMsg");
    const coinTitle = document.getElementById("coinTitle");
    const coinPrice = document.getElementById("coinPrice");
    const updatedAt = document.getElementById("updatedAt");

    async function fetchPrices() {
      try {
        const res = await fetch(API_BASE + "/prices");
        const data = await res.json();
        coins = data.coins || [];
        updatedAt.textContent = "updated " + new Date().toLocaleTimeString();
        renderCoinList();
        if (!selectedSymbol && coins.length) {
          selectCoin(coins[0].symbol);
        }
      } catch (e) {
        console.error(e);
      }
    }

    function renderCoinList(filter = "") {
      coinListEl.innerHTML = "";
      const lower = filter.toLowerCase();
      coins
        .filter(c => c.symbol.toLowerCase().includes(lower))
        .forEach(c => {
          const row = document.createElement("div");
          row.className = "coin-row" + (c.symbol === selectedSymbol ? " active" : "");
          row.onclick = () => selectCoin(c.symbol);

          const left = document.createElement("div");
          left.className = "coin-name";
          const sym = document.createElement("div");
          sym.className = "coin-symbol";
          sym.textContent = c.symbol;
          const pr = document.createElement("div");
          pr.className = "coin-price";
          pr.textContent = "$" + c.price.toLocaleString();
          left.appendChild(sym);
          left.appendChild(pr);

          const right = document.createElement("div");
          const pill = document.createElement("span");
          let pillClass = "signal-hold";
          if (c.signal === "BUY") pillClass = "signal-buy";
          if (c.signal === "SELL") pillClass = "signal-sell";
          pill.className = "signal-pill " + pillClass;
          pill.textContent = c.signal + " â€¢ " + c.confidence + "%";
          right.appendChild(pill);

          row.appendChild(left);
          row.appendChild(right);
          coinListEl.appendChild(row);
        });
    }

    async function selectCoin(symbol) {
      selectedSymbol = symbol;
      const c = coins.find(x => x.symbol === symbol);
      if (c) {
        coinTitle.textContent = c.symbol;
        coinPrice.textContent = "$" + c.price.toLocaleString();
      } else {
        coinTitle.textContent = symbol;
        coinPrice.textContent = "$0.00";
      }
      renderCoinList(document.getElementById("search").value);
      await loadHistory();
    }

    async function loadHistory() {
      if (!selectedSymbol) return;
      try {
        const res = await fetch(`${API_BASE}/history?symbol=${encodeURIComponent(selectedSymbol)}&range=${currentRange}&mode=${currentMode}`);
        if (!res.ok) throw new Error("history failed");
        const data = await res.json();
        if (!data.points) throw new Error("no points");
        drawChart(data.points, currentMode);
        chartMsg.style.display = "none";
      } catch (e) {
        console.warn(e);
        const mock = [];
        for (let i=0;i<60;i++){
          mock.push({c: 100 + Math.sin(i/5)*10});
        }
        drawChart(mock, "line");
        chartMsg.style.display = "block";
        chartMsg.textContent = "could not load history, showing mock";
      }
    }

    function clearCanvas() {
      const {width, height} = chartCanvas;
      ctx.clearRect(0,0,width,height);
      ctx.fillStyle = "#0b0c0f";
      ctx.fillRect(0,0,width,height);
    }

    function resizeCanvas() {
      const parent = chartCanvas.parentElement;
      chartCanvas.width = parent.clientWidth;
      chartCanvas.height = parent.clientHeight;
    }

    function drawChart(points, mode) {
      resizeCanvas();
      clearCanvas();
      const w = chartCanvas.width;
      const h = chartCanvas.height;

      if (!points.length) return;

      if (mode === "candles") {
        const highs = points.map(p => p.h ?? p.c);
        const lows = points.map(p => p.l ?? p.c);
        const maxV = Math.max(...highs);
        const minV = Math.min(...lows);
        const range = maxV - minV || 1;

        const candleWidth = Math.max(3, (w - 40) / points.length - 2);
        points.forEach((p, i) => {
          const x = 20 + i * ((w - 40) / points.length);
          const open = p.o ?? p.c;
          const close = p.c;
          const high = p.h ?? Math.max(open, close);
          const low = p.l ?? Math.min(open, close);

          const yHigh = 10 + (1 - (high - minV) / range) * (h - 20);
          const yLow  = 10 + (1 - (low - minV) / range) * (h - 20);
          const yOpen = 10 + (1 - (open - minV) / range) * (h - 20);
          const yClose= 10 + (1 - (close - minV) / range) * (h - 20);

          const rising = close >= open;
          ctx.strokeStyle = rising ? "#52c41a" : "#ff4d4f";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, yHigh);
          ctx.lineTo(x, yLow);
          ctx.stroke();

          ctx.fillStyle = rising ? "#52c41a" : "#ff4d4f";
          const top = Math.min(yOpen, yClose);
          const height = Math.max(Math.abs(yClose - yOpen), 2);
          ctx.fillRect(x - candleWidth/2, top, candleWidth, height);
        });
      } else {
        const vals = points.map(p => p.c);
        const maxV = Math.max(...vals);
        const minV = Math.min(...vals);
        const range = maxV - minV || 1;
        ctx.strokeStyle = "#3de3a6";
        ctx.lineWidth = 2;
        ctx.beginPath();
        points.forEach((p, i) => {
          const x = 15 + i * ((w - 30) / (points.length - 1));
          const y = 10 + (1 - (p.c - minV) / range) * (h - 20);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }
    }

    document.getElementById("search").addEventListener("input", (e) => {
      renderCoinList(e.target.value);
    });

    document.querySelectorAll("[data-range]").forEach(btn => {
      btn.addEventListener("click", async () => {
        document.querySelectorAll("[data-range]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentRange = btn.dataset.range;
        await loadHistory();
      });
    });

    document.querySelectorAll("[data-mode]").forEach(btn => {
      btn.addEventListener("click", async () => {
        document.querySelectorAll("[data-mode]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentMode = btn.dataset.mode;
        await loadHistory();
      });
    });

    document.getElementById("refreshBtn").addEventListener("click", fetchPrices);

    fetchPrices();
    setInterval(fetchPrices, 30000);
  </script>
</body>
</html>
