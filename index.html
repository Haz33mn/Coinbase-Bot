<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --panel-soft: #151515;
      --card: #1a1a1a;
      --accent: #fff;
      --muted: #666;
      --green: #3de6b2;
      --red: #ff5f6f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      padding: 1.5rem;
    }
    .app {
      width: min(1100px, 100%);
      background: var(--panel);
      border-radius: 22px;
      padding: 1rem 1rem 1.5rem;
      box-shadow: 0 10px 50px rgba(0,0,0,.4);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .title {
      font-size: 1.4rem;
      font-weight: 650;
    }
    .status {
      font-size: .75rem;
      color: #a6ffa6;
    }
    .modes button {
      background: #222;
      border: none;
      color: #fff;
      padding: .35rem .75rem;
      border-radius: 999px;
      margin-left: .25rem;
      cursor: pointer;
      font-size: .7rem;
    }
    .modes .active {
      background: #fff;
      color: #000;
      font-weight: 600;
    }
    .main {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .left {
      flex: 0 0 230px;
      background: var(--panel-soft);
      border-radius: 15px;
      padding: .5rem;
      display: flex;
      flex-direction: column;
      max-height: 460px;
      overflow-y: auto;
    }
    .search {
      background: #0c0c0c;
      border: 1px solid #222;
      border-radius: 10px;
      padding: .35rem .5rem;
      margin-bottom: .5rem;
      font-size: .7rem;
      color: #fff;
    }
    .coin {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.01);
      border: 1px solid transparent;
      border-radius: 11px;
      padding: .4rem .6rem;
      margin-bottom: .35rem;
      cursor: pointer;
      transition: .15s;
    }
    .coin.active {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.1);
    }
    .coin-name {
      font-size: .7rem;
    }
    .coin-price {
      font-size: .7rem;
      color: #ccc;
    }
    .chart-box {
      flex: 1;
      background: #0b0b0b;
      border-radius: 15px;
      padding: .7rem .7rem 0;
      min-height: 460px;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
    .chart-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .coin-title { font-size: .8rem; }
    .ranges button, .types button {
      background: #121212;
      color: #fff;
      border: none;
      padding: .25rem .5rem;
      border-radius: 999px;
      font-size: .65rem;
      margin-left: .3rem;
      cursor: pointer;
    }
    .ranges .active, .types .active {
      background: #fff;
      color: #000;
      font-weight: 600;
    }
    .chart-wrapper {
      flex: 1;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas { width: 100%; height: 320px; }
    .refresh {
      background: #fff;
      color: #000;
      border: none;
      border-radius: 999px;
      padding: .55rem 1rem;
      width: 100%;
      margin-top: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      .left { flex: none; max-height: 200px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">My Coinbase Bot</div>
        <div class="status"><span style="color:#00ff73;">●</span> connected to bot</div>
      </div>
      <div class="modes" id="modes">
        <button data-mode="off" class="active">Off</button>
        <button data-mode="paper">Paper</button>
        <button data-mode="live">Live</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <input class="search" placeholder="search coin..." id="search" />
        <div id="list"></div>
      </div>

      <div class="chart-box">
        <div class="chart-top">
          <div>
            <div class="coin-title" id="coinTitle">BTC-USD</div>
            <div id="coinPrice" style="font-size:.7rem;color:#aaa;">--</div>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center;">
            <div class="ranges" id="ranges">
              <button data-range="1D" class="active">1D</button>
              <button data-range="1W">1W</button>
              <button data-range="1M">1M</button>
              <button data-range="6M">6M</button>
              <button data-range="1Y">1Y</button>
            </div>
            <div class="types" id="types">
              <button data-type="line" class="active">Line</button>
              <button data-type="candles">Candles</button>
            </div>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart"></canvas>
        </div>
        <div id="updated" style="font-size:.6rem;color:#777;margin:.3rem 0 .6rem;">updated --</div>
      </div>
    </div>

    <button class="refresh" id="refresh">Refresh</button>
  </div>

  <script>
    const API = window.location.origin;
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const chartCanvas = document.getElementById("chart");
    const ctx = chartCanvas.getContext("2d");
    const rangesEl = document.getElementById("ranges");
    const typesEl = document.getElementById("types");
    const modesEl = document.getElementById("modes");
    const updatedEl = document.getElementById("updated");
    const refreshBtn = document.getElementById("refresh");
    const coinTitleEl = document.getElementById("coinTitle");
    const coinPriceEl = document.getElementById("coinPrice");

    let currentCoin = "BTC-USD";
    let currentRange = "1D";
    let currentType = "line";
    let pricesCache = {};

    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error("bad resp");
      return r.json();
    }

    async function loadPrices() {
      const data = await fetchJSON(API + "/prices");
      pricesCache = data.coins || {};
      updatedEl.textContent = "updated " + (data.updated || "--");
      renderList();
    }

    async function loadHistory() {
      const data = await fetchJSON(`${API}/history/${currentCoin}?range=${currentRange}`);
      if (data.fallback) {
        drawFallback();
      } else {
        drawChart(data.candles || []);
      }
    }

    function renderList(filter="") {
      listEl.innerHTML = "";
      Object.entries(pricesCache)
        .filter(([sym]) => sym.toLowerCase().includes(filter.toLowerCase()))
        .forEach(([sym, price]) => {
          const div = document.createElement("div");
          div.className = "coin" + (sym === currentCoin ? " active":"");
          div.innerHTML = `
            <div>
              <div class="coin-name">${sym}</div>
              <div class="coin-price">$${price.toFixed(3)}</div>
            </div>
            <div style="font-size:.6rem;color:#999;">HOLD · 50%</div>
          `;
          div.onclick = () => {
            currentCoin = sym;
            coinTitleEl.textContent = sym;
            coinPriceEl.textContent = "$" + price.toFixed(3);
            renderList(filter);
            loadHistory();
          };
          listEl.appendChild(div);
        });
      if (pricesCache[currentCoin]) {
        coinPriceEl.textContent = "$" + pricesCache[currentCoin].toFixed(3);
      }
    }

    function drawChart(candles) {
      const w = chartCanvas.width = chartCanvas.clientWidth * devicePixelRatio;
      const h = chartCanvas.height = 320 * devicePixelRatio;
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      ctx.clearRect(0,0,w,h);

      const lows = candles.map(c => c.low);
      const highs = candles.map(c => c.high);
      const min = Math.min(...lows);
      const max = Math.max(...highs);
      const pad = 10;

      if (currentType === "line") {
        ctx.beginPath();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#33f7d1";
        candles.forEach((c, i) => {
          const x = (i / Math.max(1, candles.length-1)) * (w/devicePixelRatio);
          const val = c.close;
          const y = (h/devicePixelRatio) - ((val - min)/(max-min)) * ((h/devicePixelRatio)-pad*2) - pad;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      } else {
        const cw = (w/devicePixelRatio) / Math.max(1, candles.length);
        candles.forEach((c, i) => {
          const x = i * cw + cw*0.15;
          const open = c.open, close = c.close;
          const high = c.high, low = c.low;
          const yHigh = (h/devicePixelRatio) - ((high - min)/(max-min)) * ((h/devicePixelRatio)-pad*2) - pad;
          const yLow = (h/devicePixelRatio) - ((low - min)/(max-min)) * ((h/devicePixelRatio)-pad*2) - pad;
          const yOpen = (h/devicePixelRatio) - ((open - min)/(max-min)) * ((h/devicePixelRatio)-pad*2) - pad;
          const yClose = (h/devicePixelRatio) - ((close - min)/(max-min)) * ((h/devicePixelRatio)-pad*2) - pad;
          const isUp = close >= open;
          ctx.strokeStyle = isUp ? "#3de6b2" : "#ff5f6f";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x+cw*0.25, yHigh);
          ctx.lineTo(x+cw*0.25, yLow);
          ctx.stroke();
          ctx.fillStyle = isUp ? "#3de6b2" : "#ff5f6f";
          const bodyY = isUp ? yClose : yOpen;
          const bodyH = Math.abs(yOpen - yClose);
          ctx.fillRect(x, bodyY, cw*0.5, Math.max(2, bodyH));
        });
      }
    }

    function drawFallback() {
      const w = chartCanvas.width = chartCanvas.clientWidth * devicePixelRatio;
      const h = chartCanvas.height = 320 * devicePixelRatio;
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      ctx.clearRect(0,0,w,h);
      ctx.beginPath();
      ctx.strokeStyle = "#33f7d1";
      ctx.lineWidth = 2;
      for (let i=0;i<40;i++){
        const x = (i/39)*(w/devicePixelRatio);
        const y = (h/devicePixelRatio)/2 + Math.sin(i/4)*60;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
      ctx.fillStyle = "#ff5f6f";
      ctx.font = "10px system-ui";
      ctx.fillText("fallback data", (w/devicePixelRatio)-90, (h/devicePixelRatio)-10);
    }

    refreshBtn.onclick = () => {
      loadPrices().then(loadHistory);
    };

    searchEl.oninput = e => {
      renderList(e.target.value);
    };

    rangesEl.onclick = e => {
      const b = e.target.closest("button");
      if (!b) return;
      currentRange = b.dataset.range;
      [...rangesEl.children].forEach(x=>x.classList.toggle("active", x===b));
      loadHistory();
    };

    typesEl.onclick = e => {
      const b = e.target.closest("button");
      if (!b) return;
      currentType = b.dataset.type;
      [...typesEl.children].forEach(x=>x.classList.toggle("active", x===b));
      loadHistory();
    };

    modesEl.onclick = async e => {
      const b = e.target.closest("button");
      if (!b) return;
      const mode = b.dataset.mode;
      await fetch(API + "/trade-mode?mode=" + mode, { method: "POST" });
      [...modesEl.children].forEach(x=>x.classList.toggle("active", x===b));
    };

    // initial
    loadPrices().then(loadHistory);
  </script>
</body>
</html>
