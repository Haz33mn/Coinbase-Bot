<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Coinbase Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --card: rgba(15,23,42,0.3);
      --border: rgba(148,163,184,0.1);
      --accent: #38bdf8;
    }
    [data-theme="light"] {
      --bg: #f1f5f9;
      --fg: #0f172a;
      --card: #fff;
      --border: rgba(148,163,184,0.3);
      --accent: #0ea5e9;
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem 1rem;
      transition: background .3s, color .3s;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      width: min(980px, 100%);
      padding: 1.5rem;
      box-shadow: 0 12px 35px rgba(0,0,0,0.25);
      position: relative;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    /* settings button */
    #settingsBtn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: .75rem;
      padding: .4rem .7rem;
      font-weight: 600;
      cursor: pointer;
      font-size: .8rem;
    }
    #settingsMenu {
      display: none;
      position: absolute;
      top: 3rem;
      right: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: .75rem;
      padding: .75rem;
      width: 160px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }
    #settingsMenu button {
      width: 100%;
      padding: .35rem .5rem;
      border-radius: .5rem;
      background: none;
      border: 1px solid var(--border);
      color: var(--fg);
      cursor: pointer;
      font-size: .8rem;
    }
    #settingsMenu button:hover {
      background: var(--accent);
      color: var(--bg);
    }

    .layout {
      display: flex;
      gap: 1.25rem;
    }
    .list {
      width: 34%;
      display: flex;
      flex-direction: column;
      gap: .35rem;
      max-height: 360px;
      overflow-y: auto;
    }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .5rem .4rem .75rem;
      border-radius: .6rem;
      cursor: pointer;
      transition: background .12s;
    }
    .row:hover { background: rgba(148,163,184,0.06); }
    .row.active { background: rgba(56,189,248,0.12); outline: 1px solid rgba(56,189,248,0.3); }
    .right { display: flex; gap: .5rem; align-items: center; }
    .tag { padding: 2px 8px; border-radius: 999px; font-size: .6rem; font-weight: 600; }
    .buy { background: rgba(34,197,94,.15); color: #22c55e; }
    .sell { background: rgba(248,113,113,.15); color: #f87171; }
    .hold { background: rgba(59,130,246,.15); color: #3b82f6; }
    .avoid { background: rgba(244,63,94,.15); color: #f43f5e; }

    .chart-wrap {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: .75rem .75rem 1rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
    .chart-top { display: flex; justify-content: space-between; align-items: center; }
    .range-buttons, .type-buttons { display: flex; gap: .4rem; flex-wrap: wrap; }
    .btn-sm {
      background: rgba(148,163,184,0.05);
      border: 1px solid transparent;
      border-radius: .75rem;
      padding: .25rem .6rem;
      font-size: .7rem;
      cursor: pointer;
      color: var(--fg);
    }
    .btn-sm.active {
      background: rgba(56,189,248,0.16);
      border-color: rgba(56,189,248,0.4);
      color: var(--fg);
    }
    canvas { background: rgba(15,23,42,0.15); border-radius: .75rem; }
    button.refresh {
      background: var(--accent);
      border: none;
      border-radius: .75rem;
      padding: .45rem .9rem;
      color: var(--bg);
      font-weight: 600;
      cursor: pointer;
      margin-top: .5rem;
      width: 100%;
    }
    small { opacity: .6; display: block; margin-top: .35rem; font-size: .7rem; }
    @media (max-width: 820px) { .layout { flex-direction: column; } .list { width: 100%; max-height: 220px; } }
  </style>
</head>
<body>
  <div class="card">
    <button id="settingsBtn" onclick="toggleSettings()">⚙️ Settings</button>
    <div id="settingsMenu">
      <button onclick="setTheme('dark')">Dark Mode</button>
      <button onclick="setTheme('light')">Light Mode</button>
    </div>

    <h1>My Coinbase Bot</h1>

    <div class="layout">
      <div id="list" class="list">loading…</div>
      <div class="chart-wrap">
        <div class="chart-top">
          <div>
            <div id="chart-title">Select a coin</div>
            <div id="chart-price" style="font-size:.8rem;opacity:.7"></div>
          </div>
          <div class="type-buttons">
            <button class="btn-sm active" id="btn-line" onclick="setChartType('line')">Line</button>
            <button class="btn-sm" id="btn-candle" onclick="setChartType('candle')">Candles</button>
          </div>
        </div>
        <div class="range-buttons">
          <button class="btn-sm active" onclick="setRange('24h')">24h</button>
          <button class="btn-sm" onclick="setRange('1m')">1M</button>
          <button class="btn-sm" onclick="setRange('6m')">6M</button>
          <button class="btn-sm" onclick="setRange('1y')">1Y</button>
        </div>
        <canvas id="chart" height="210"></canvas>
        <small id="status">loading…</small>
      </div>
    </div>

    <button class="refresh" onclick="refreshAll()">Refresh</button>

    <div style="margin-top:1rem">
      <h2 style="font-size:1rem;margin-bottom:.5rem;">Top 10 Buys Now</h2>
      <div id="top10" style="
          background:var(--card);
          border:1px solid var(--border);
          border-radius:.75rem;
          padding:.75rem;
          max-height:200px;
          overflow-y:auto;
          font-size:.9rem;">
        loading…
      </div>
      <button class="refresh" onclick="refreshTop10()">Reload Top 10</button>
    </div>
  </div>

  <script>
    // ====== Theme toggle ======
    const root = document.documentElement;
    function setTheme(mode) {
      root.dataset.theme = mode;
      localStorage.setItem("theme", mode);
      document.getElementById("settingsMenu").style.display = "none";
    }
    function toggleSettings() {
      const menu = document.getElementById("settingsMenu");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }
    // load saved theme
    const savedTheme = localStorage.getItem("theme") || "dark";
    root.dataset.theme = savedTheme;

    // ====== main app logic (unchanged from previous version) ======
    let selectedPair = null;
    let selectedRange = "24h";
    let chartType = "line";
    let lastPrices = {};
    async function refreshAll() {
      const status = document.getElementById("status");
      status.textContent = "loading…";
      try {
        const [pricesRes, signalsRes] = await Promise.all([
          fetch("/prices"),
          fetch("/signals")
        ]);
        const prices = await pricesRes.json();
        const signals = await signalsRes.json();
        lastPrices = prices;
        renderList(prices, signals);
        if (!selectedPair) selectedPair = Object.keys(prices)[0];
        await loadCandles(selectedPair, selectedRange);
        status.textContent = "updated " + new Date().toLocaleTimeString();
      } catch { status.textContent = "failed"; }
    }

    function renderList(prices, signals) {
      const list = document.getElementById("list");
      list.innerHTML = "";
      Object.keys(prices).forEach(pair => {
        const price = prices[pair];
        const sigObj = signals[pair] || { signal: "HOLD" };
        const s = sigObj.signal;
        let cls = "hold";
        if (s === "BUY") cls = "buy";
        else if (s === "SELL") cls = "sell";
        else if (s === "AVOID") cls = "avoid";
        const row = document.createElement("div");
        row.className = "row" + (pair === selectedPair ? " active" : "");
        row.onclick = () => {
          selectedPair = pair;
          renderList(prices, signals);
          loadCandles(pair, selectedRange);
        };
        row.innerHTML = `<span>${pair}</span>
          <span class="right">
            <span>$${Number(price).toLocaleString()}</span>
            <span class="tag ${cls}">${s}${sigObj.confidence ? " · " + Math.round(sigObj.confidence*100) + "%" : ""}</span>
          </span>`;
        list.appendChild(row);
      });
    }

    function setRange(r) {
      selectedRange = r;
      document.querySelectorAll(".range-buttons .btn-sm").forEach(btn => {
        btn.classList.toggle("active", btn.textContent.replace(/\s/g,'').toLowerCase() === r.toLowerCase());
      });
      if (selectedPair) loadCandles(selectedPair, selectedRange);
    }
    function setChartType(t) {
      chartType = t;
      document.getElementById("btn-line").classList.toggle("active", t === "line");
      document.getElementById("btn-candle").classList.toggle("active", t === "candle");
      if (selectedPair) loadCandles(selectedPair, selectedRange, true);
    }

    async function loadCandles(pair, range, skipFetch=false) {
      const title = document.getElementById("chart-title");
      const priceEl = document.getElementById("chart-price");
      title.textContent = pair;
      priceEl.textContent = lastPrices[pair] ? "$" + Number(lastPrices[pair]).toLocaleString() : "";
      let data;
      if (!skipFetch) {
        const res = await fetch(`/candles/${pair}?range=${range}`);
        data = await res.json();
        window._lastCandles = data.candles || [];
      } else data = { candles: window._lastCandles || [] };
      drawChart(data.candles || []);
    }

    function drawChart(candles) {
      const canvas = document.getElementById("chart");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!candles.length) { ctx.fillText("no data…", 10, 30); return; }
      const w = canvas.width, h = canvas.height;
      if (chartType === "line") {
        const closes = candles.map(c => c.close);
        const max = Math.max(...closes), min = Math.min(...closes);
        const spread = (max - min) || 1;
        ctx.lineWidth = 2;
        const up = closes[closes.length - 1] >= closes[0];
        ctx.strokeStyle = up ? "#22c55e" : "#ef4444";
        ctx.beginPath();
        closes.forEach((val, i) => {
          const x = (i / Math.max(closes.length - 1, 1)) * (w - 10) + 5;
          const y = h - ((val - min) / spread) * (h - 10) - 5;
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
      } else {
        const highs = candles.map(c => c.high);
        const lows = candles.map(c => c.low);
        const max = Math.max(...highs), min = Math.min(...lows);
        const spread = (max - min) || 1;
        const barW = Math.max(4, (w - 10) / candles.length - 2);
        candles.forEach((c, i) => {
          const x = (i / Math.max(candles.length - 1, 1)) * (w - 10) + 5;
          const openY = h - ((c.open - min) / spread) * (h - 10) - 5;
          const closeY = h - ((c.close - min) / spread) * (h - 10) - 5;
          const highY = h - ((c.high - min) / spread) * (h - 10) - 5;
          const lowY = h - ((c.low - min) / spread) * (h - 10) - 5;
          const bullish = c.close >= c.open;
          ctx.strokeStyle = bullish ? "#22c55e" : "#ef4444";
          ctx.beginPath(); ctx.moveTo(x, highY); ctx.lineTo(x, lowY); ctx.stroke();
          ctx.fillStyle = bullish ? "rgba(34,197,94,.45)" : "rgba(239,68,68,.5)";
          const bodyY = bullish ? closeY : openY;
          const bodyH = Math.max(2, Math.abs(closeY - openY));
          ctx.fillRect(x - barW/2, bodyY, barW, bodyH);
        });
      }
    }

    async function refreshTop10() {
      const box = document.getElementById("top10");
      box.innerHTML = "loading…";
      try {
        const res = await fetch("/signals");
        const data = await res.json();
        const buys = Object.entries(data)
          .filter(([_, v]) => v.signal === "BUY")
          .sort((a,b)=> (b[1].confidence||0)-(a[1].confidence||0))
          .slice(0,10);
        if(!buys.length){ box.innerHTML="<i>No strong buy setups right now</i>"; return; }
        box.innerHTML = buys.map(([pair,v])=>`
          <div style="display:flex;justify-content:space-between;margin-bottom:.25rem;">
            <span>${pair}</span>
            <span style="color:#22c55e;font-weight:600;">${Math.round((v.confidence||0)*100)}%</span>
          </div>`).join("");
      } catch { box.innerHTML="error loading"; }
    }

    setInterval(refreshAll, 10000);
    setInterval(refreshTop10, 10000);
    refreshAll();
    refreshTop10();
  </script>
</body>
</html>
